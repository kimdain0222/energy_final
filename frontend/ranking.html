<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë­í‚¹ - ì—ë„ˆì§€ ì ˆì•½ í”Œë«í¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .ranking-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .top-rank {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            font-weight: bold;
        }
        .my-rank {
            background-color: #e7f3ff;
            border-left: 4px solid #0d6efd;
        }
        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
        }
        .rank-1 { background: #ffd700; color: #000; }
        .rank-2 { background: #c0c0c0; color: #000; }
        .rank-3 { background: #cd7f32; color: #fff; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="index.html">âš¡ ì—ë„ˆì§€ì ˆì•½</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">ëŒ€ì‹œë³´ë“œ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="challenge.html">ì±Œë¦°ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="ranking.html">ë­í‚¹</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="programs.html">ì§€ì›ì‚¬ì—…</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="fw-bold mb-2">ğŸ† ì—ë„ˆì§€ ì ˆì•½ ë­í‚¹</h2>
                <p class="text-muted">ë‹¤ë¥¸ ì‚¬ìš©ìì™€ ì ˆì•½ëŸ‰ì„ ë¹„êµí•´ë³´ì„¸ìš”</p>
            </div>
        </div>

        <!-- í•„í„° -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">ì§€ì—­</label>
                        <select class="form-select" id="filterRegion" onchange="loadRankings()">
                            <option value="ì „ì²´">ì „ì²´</option>
                            <option value="ì„œìš¸">ì„œìš¸</option>
                            <option value="ê²½ê¸°">ê²½ê¸°</option>
                            <option value="ì¸ì²œ">ì¸ì²œ</option>
                            <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                            <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                            <option value="ëŒ€ì „">ëŒ€ì „</option>
                            <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                            <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                            <option value="ì„¸ì¢…">ì„¸ì¢…</option>
                            <option value="ê²½ë¶">ê²½ë¶</option>
                            <option value="ê²½ë‚¨">ê²½ë‚¨</option>
                            <option value="ì¶©ë¶">ì¶©ë¶</option>
                            <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
                            <option value="ì „ë¶">ì „ë¶</option>
                            <option value="ì „ë‚¨">ì „ë‚¨</option>
                            <option value="ê°•ì›">ê°•ì›</option>
                            <option value="ì œì£¼">ì œì£¼</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ì£¼íƒ ìœ í˜•</label>
                        <select class="form-select" id="filterHousingType" onchange="loadRankings()">
                            <option value="ì „ì²´">ì „ì²´</option>
                            <option value="ì•„íŒŒíŠ¸">ì•„íŒŒíŠ¸</option>
                            <option value="ì£¼íƒ">ì£¼íƒ</option>
                            <option value="ì˜¤í”¼ìŠ¤í…”">ì˜¤í”¼ìŠ¤í…”</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-secondary w-100" onclick="resetFilters()">í•„í„° ì´ˆê¸°í™”</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë‚´ ìˆœìœ„ ì¹´ë“œ -->
        <div class="card border-0 shadow-lg mb-4 bg-primary text-white" id="myRankCard" style="display: none;">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <h2 class="fw-bold mb-0" id="myRankNumber">-</h2>
                        <small>ìœ„</small>
                    </div>
                    <div class="col-md-6">
                        <h5 class="fw-bold mb-1" id="myRankName">-</h5>
                        <p class="mb-0">ì ˆì•½ëŸ‰: <span id="myRankSaved">0</span> kWh | ë‹¬ì„±ë¥ : <span id="myRankAchievement">0</span>%</p>
                    </div>
                    <div class="col-md-3 text-end">
                        <a href="challenge.html" class="btn btn-light">ì±Œë¦°ì§€ ë³´ê¸°</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¦¬ë”ë³´ë“œ -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table ranking-table mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px;">ìˆœìœ„</th>
                                <th>ì‚¬ìš©ì</th>
                                <th>ì§€ì—­</th>
                                <th class="text-end">ì ˆì•½ëŸ‰</th>
                                <th class="text-end">ëª©í‘œë‹¬ì„±ë¥ </th>
                            </tr>
                        </thead>
                        <tbody id="rankingTable">
                            <tr>
                                <td colspan="5" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ë¹„êµ ì°¨íŠ¸ -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-4">ë‚´ vs í‰ê·  vs ìƒìœ„ê¶Œ</h5>
                <canvas id="comparisonChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!user.id) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        let comparisonChart = null;

        async function loadRankings() {
            const region = document.getElementById('filterRegion').value;
            const housingType = document.getElementById('filterHousingType').value;

            try {
                let url = '/api/ranking?';
                if (region && region !== 'ì „ì²´') url += `region=${encodeURIComponent(region)}&`;
                if (housingType && housingType !== 'ì „ì²´') url += `housingType=${encodeURIComponent(housingType)}&`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    displayRankings(data.rankings);
                    updateComparisonChart(data.rankings);
                }
            } catch (error) {
                console.error('ë­í‚¹ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        function displayRankings(rankings) {
            const tbody = document.getElementById('rankingTable');
            const myRanking = rankings.find(r => r.id === user.id);

            if (myRanking) {
                document.getElementById('myRankCard').style.display = 'block';
                document.getElementById('myRankNumber').textContent = myRanking.rank;
                document.getElementById('myRankName').textContent = myRanking.name || user.name;
                document.getElementById('myRankSaved').textContent = (myRanking.savedKwh || 0).toLocaleString();
                document.getElementById('myRankAchievement').textContent = myRanking.achievementRate || 0;
            } else {
                document.getElementById('myRankCard').style.display = 'none';
            }

            tbody.innerHTML = rankings.slice(0, 50).map((r, index) => {
                const rankClass = r.rank === 1 ? 'rank-1' : r.rank === 2 ? 'rank-2' : r.rank === 3 ? 'rank-3' : '';
                const rowClass = r.id === user.id ? 'my-rank' : (r.rank <= 3 ? 'top-rank' : '');
                
                return `
                    <tr class="${rowClass}">
                        <td>
                            ${r.rank <= 3 ? `<span class="rank-badge ${rankClass}">${r.rank}</span>` : r.rank}
                        </td>
                        <td>
                            <strong>${r.name || 'ì‚¬ìš©ì'}</strong>
                            ${r.rank === 1 ? ' ğŸ¥‡' : r.rank === 2 ? ' ğŸ¥ˆ' : r.rank === 3 ? ' ğŸ¥‰' : ''}
                        </td>
                        <td>${r.region || '-'}</td>
                        <td class="text-end">
                            <strong class="text-success">${(r.savedKwh || 0).toLocaleString()}</strong> kWh
                        </td>
                        <td class="text-end">
                            <span class="badge ${r.achievementRate >= 100 ? 'bg-success' : 'bg-warning'}">
                                ${r.achievementRate || 0}%
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateComparisonChart(rankings) {
            const myRanking = rankings.find(r => r.id === user.id);
            const avgSaved = rankings.length > 0 
                ? Math.round(rankings.reduce((sum, r) => sum + (r.savedKwh || 0), 0) / rankings.length)
                : 0;
            const topSaved = rankings.length > 0 
                ? Math.round(rankings.slice(0, Math.ceil(rankings.length * 0.1)).reduce((sum, r) => sum + (r.savedKwh || 0), 0) / Math.ceil(rankings.length * 0.1))
                : 0;

            const ctx = document.getElementById('comparisonChart');
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ë‚´ ì ˆì•½ëŸ‰', 'í‰ê· ', 'ìƒìœ„ 10%'],
                    datasets: [{
                        label: 'ì ˆì•½ëŸ‰ (kWh)',
                        data: [
                            myRanking?.savedKwh || 0,
                            avgSaved,
                            topSaved
                        ],
                        backgroundColor: ['#0d6efd', '#6c757d', '#ffc107']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function resetFilters() {
            document.getElementById('filterRegion').value = 'ì „ì²´';
            document.getElementById('filterHousingType').value = 'ì „ì²´';
            loadRankings();
        }

        loadRankings();
    </script>
</body>
</html>

