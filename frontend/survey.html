<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ì¶¤í˜• ì ˆì•½íŒ ë°›ê¸° - ì—ë„ˆì§€ ì ˆì•½ í”Œë«í¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="chill-theme">
    <nav class="navbar navbar-expand-lg chill-navbar">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">ğŸƒ ecopass</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">ë¡œë¹„</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="programs.html">ì§€ì›ì‚¬ì—…</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="challenge.html">ì±Œë¦°ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ranking.html">ë­í‚¹</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="challenge-list.html">ê°™ì´í•´ìš”</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <main class="chill-main">
        <section class="chill-hero">
            <div class="container">
                <div class="row align-items-center g-5">
                    <div class="col-lg-6">
                        <span class="chill-pill">ì°¨ë¶„í•˜ê²Œ ì§„ë‹¨í•˜ëŠ” ì—ë„ˆì§€ ë£¨í‹´</span>
                        <h1 class="chill-hero-title">Chillê³¼ í•¨ê»˜í•˜ëŠ”<br>ë§ì¶¤ ì„¤ë¬¸ìœ¼ë¡œ ìƒí™œ íŒ¨í„´ ì •ë¦¬í•˜ê¸°</h1>
                        <p class="chill-hero-sub">í­ê·„ ì¹œêµ¬ Chillì´ ë‹¹ì‹ ì˜ ìƒí™œ ìŠµê´€ì„ ì°¬ì°¬íˆ ì‚´í´ë³´ê³ , í˜„ì‹¤ì ì¸ ì ˆì•½ ë£¨í‹´ì„ ì œì•ˆí•´ ë“œë ¤ìš”. ì„¤ë¬¸ì„ ì™„ë£Œí•˜ë©´ ë” ì •í™•í•œ ì˜ˆì¸¡ê³¼ ì§€ì›ê¸ˆ ì¶”ì²œì´ ì¤€ë¹„ë©ë‹ˆë‹¤.</p>
                        <ul class="chill-hero-checklist">
                            <li><span>â„ï¸</span> ì§€ì—­Â·ì£¼íƒí˜•ì— ë§ì¶˜ ì—ë„ˆì§€ ì‚¬ìš© ì˜ˆì¸¡</li>
                            <li><span>ğŸ“ˆ</span> ê³„ì ˆ ë³€ë™ê¹Œì§€ ê³ ë ¤í•œ ì‹ ë¢°ë„ 85% ë¶„ì„</li>
                            <li><span>ğŸ¯</span> Chillì´ ê³ ë¥¸ ì‹¤ì²œ ê°€ëŠ¥í•œ ì ˆì•½ ë¯¸ì…˜</li>
                        </ul>
                        <div class="chill-hero-meta">
                            <div>
                                <strong>3ë¶„ ì„¤ë¬¸</strong>
                                <span>ê°„ë‹¨í•œ 8ê°œ ì§ˆë¬¸</span>
                            </div>
                            <div>
                                <strong>ë§ì¶¤ ì¶”ì²œ</strong>
                                <span>ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ ì ˆì•½ íŒ</span>
                            </div>
                            <div>
                                <strong>ì§€ì›ê¸ˆ ì—°ë™</strong>
                                <span>ì˜ˆì¸¡ ê²°ê³¼ ê¸°ë°˜ ì¶”ì²œ</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chill-hero-visual">
                            <img src="characters/chill.png" alt="Chill ìºë¦­í„°" loading="lazy">
                            <div class="chill-hero-speech">
                                <b>"ì‚°ëœ»í•˜ê²Œ ì •ë¦¬í•´ ë³¼ê¹Œìš”?"</b>
                                <span>ì—¬ìœ ë¡­ê²Œ ë‹µí•˜ë©´ Chillì´ ì°¨ë¶„í•˜ê²Œ ë¶„ì„í•´ ë“œë¦´ê²Œìš”.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="chill-form-section">
            <div class="container">
                <div class="row g-4 align-items-start">
                    <div class="col-lg-7">
                        <div class="chill-form-card">
                            <div class="chill-form-header">
                                <div class="chill-step">STEP 1</div>
                                <div>
                                    <h2>ì‚´ê³  ìˆëŠ” ì§‘ì„ ì•Œë ¤ì£¼ì„¸ìš”</h2>
                                    <p>ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ Chillì´ ìš°ë¦¬ ì§‘ì— ë”± ë§ëŠ” ê¸°ì¤€ì„ ì¡ì•„ìš”.</p>
                                </div>
                            </div>

                            <form id="surveyForm" class="chill-form">
                                <!-- ê¸°ë³¸ ì •ë³´ -->
                                <div class="chill-fieldset">
                                    <h5>ê¸°ë³¸ ì •ë³´</h5>
                                    <p class="chill-fieldset-sub">ì§€ì—­Â·ì£¼íƒí˜•Â·ê°€êµ¬ ê·œëª¨ë¥¼ ì•Œë ¤ì£¼ì‹œë©´ í†µê³„ ê¸°ì¤€ì„ ì •êµí•˜ê²Œ ë§ì¶œ ìˆ˜ ìˆì–´ìš”.</p>

                                    <div class="mb-3">
                                        <label class="form-label">ê±°ì£¼ ì§€ì—­</label>
                                        <select class="form-select" id="region" required>
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="ì„œìš¸">ì„œìš¸</option>
                                            <option value="ê²½ê¸°">ê²½ê¸°</option>
                                            <option value="ì¸ì²œ">ì¸ì²œ</option>
                                            <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                                            <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                                            <option value="ëŒ€ì „">ëŒ€ì „</option>
                                            <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                                            <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                                            <option value="ì„¸ì¢…">ì„¸ì¢…</option>
                                            <option value="ê²½ë¶">ê²½ë¶</option>
                                            <option value="ê²½ë‚¨">ê²½ë‚¨</option>
                                            <option value="ì¶©ë¶">ì¶©ë¶</option>
                                            <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
                                            <option value="ì „ë¶">ì „ë¶</option>
                                            <option value="ì „ë‚¨">ì „ë‚¨</option>
                                            <option value="ê°•ì›">ê°•ì›</option>
                                            <option value="ì œì£¼">ì œì£¼</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">ì£¼íƒ ìœ í˜•</label>
                                        <select class="form-select" id="housingType" required>
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="ì•„íŒŒíŠ¸">ì•„íŒŒíŠ¸</option>
                                            <option value="ë‹¨ë…ì£¼íƒ">ë‹¨ë…ì£¼íƒ</option>
                                            <option value="ì˜¤í”¼ìŠ¤í…”">ì˜¤í”¼ìŠ¤í…”</option>
                                        </select>
                                    </div>

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">ë©´ì  (í‰)</label>
                                            <input type="number" class="form-control" id="area" placeholder="ì˜ˆ: 30" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">ê°€ì¡± ìˆ˜</label>
                                            <input type="number" class="form-control" id="householdSize" placeholder="ì˜ˆ: 4" min="1" max="10" required>
                                        </div>
                                    </div>
                                </div>

                                <!-- ì—ë„ˆì§€ ì‚¬ìš© ìŠµê´€ -->
                                <div class="chill-fieldset">
                                    <h5>ì—ë„ˆì§€ ì‚¬ìš© ìŠµê´€</h5>
                                    <p class="chill-fieldset-sub">ì‹¤ì œ ìƒí™œ íŒ¨í„´ì„ ë°˜ì˜í•˜ë©´ Chillì´ ë” ì •í™•í•œ ì ˆì•½ ëª¨ë¸ì„ ë§Œë“¤ì–´ì¤˜ìš”.</p>

                                    <div class="mb-3">
                                        <label class="form-label">ì—ì–´ì»¨ ì‚¬ìš© ë¹ˆë„</label>
                                        <small class="text-muted d-block mb-2">ì—¬ë¦„ ê¸°ì¤€ìœ¼ë¡œ ì£¼ ëª‡ íšŒ ì‚¬ìš©í•˜ì‹œëŠ”ì§€ ì„ íƒí•´ì£¼ì„¸ìš”</small>
                                        <select class="form-select" id="aircon" required>
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="ê±°ì˜ ì‚¬ìš©ì•ˆí•¨">ê±°ì˜ ì‚¬ìš©ì•ˆí•¨ (ì—¬ë¦„ ê¸°ì¤€: ì£¼ 0-1íšŒ)</option>
                                            <option value="ê°€ë” ì‚¬ìš©">ê°€ë” ì‚¬ìš© (ì—¬ë¦„ ê¸°ì¤€: ì£¼ 2-3íšŒ)</option>
                                            <option value="ìì£¼ ì‚¬ìš©">ìì£¼ ì‚¬ìš© (ì—¬ë¦„ ê¸°ì¤€: ì£¼ 4-5íšŒ)</option>
                                            <option value="ê±°ì˜ í•­ìƒ">ê±°ì˜ í•­ìƒ (ì—¬ë¦„ ê¸°ì¤€: ì£¼ 6-7íšŒ)</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë‚œë°© ë°©ì‹</label>
                                        <select class="form-select" id="heating" required>
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="ë„ì‹œê°€ìŠ¤">ë„ì‹œê°€ìŠ¤</option>
                                            <option value="ì „ê¸°íˆí„°">ì „ê¸°íˆí„°</option>
                                            <option value="ì§€ì—­ë‚œë°©">ì§€ì—­ë‚œë°©</option>
                                            <option value="ê¸°ë¦„ë³´ì¼ëŸ¬">ê¸°ë¦„ë³´ì¼ëŸ¬</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">ì¡°ëª… ì‚¬ìš© í˜„í™©</label>
                                        <select class="form-select" id="lighting" required>
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="í˜•ê´‘ë“± ìœ„ì£¼">í˜•ê´‘ë“± ìœ„ì£¼</option>
                                            <option value="LED ì¼ë¶€">LED ì¼ë¶€</option>
                                            <option value="LED ëŒ€ë¶€ë¶„">LED ëŒ€ë¶€ë¶„</option>
                                            <option value="LED ì „ë¶€">LED ì „ë¶€</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">ê°€ì „ì œí’ˆ ì‚¬ìš©ëŸ‰</label>
                                        <select class="form-select" id="appliances" required>
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="ì ìŒ">ì ìŒ</option>
                                            <option value="ë³´í†µ">ë³´í†µ</option>
                                            <option value="ë§ìŒ">ë§ìŒ</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- ì˜ˆì¸¡ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
                                <div class="chill-preview" id="predictionPreview" style="display: none;">
                                    <div class="chill-preview-header">
                                        <div class="chill-preview-icon">ğŸ“Š</div>
                                        <div>
                                            <h6>ì˜ˆì¸¡ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h6>
                                            <span>Chillì´ ì¤€ë¹„í•œ ë§ì¶¤ ì—ë„ˆì§€ ë¦¬í¬íŠ¸ì—ìš”.</span>
                                        </div>
                                    </div>
                                    <div id="predictionContent"></div>
                                </div>

                                <div class="d-flex flex-column flex-md-row gap-3 mt-4">
                                    <button type="submit" class="btn chill-btn-primary flex-fill">ì„¤ë¬¸ ì œì¶œí•˜ê¸°</button>
                                    <button type="button" class="btn chill-btn-outline" onclick="previewPrediction()">ë¯¸ë¦¬ë³´ê¸°</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="chill-side-card chill-progress-card" id="chillChallengeCard">
                            <div class="chill-progress-header">
                                <div class="chill-progress-icon">ğŸ”ï¸</div>
                                <div>
                                    <h4>ë‚´ ì±Œë¦°ì§€ í˜„í™©</h4>
                                    <p>ìµœê·¼ ì§„í–‰ ì¤‘ì¸ ì ˆì•½ ë¯¸ì…˜ì„ í•œëˆˆì— í™•ì¸í•´ìš”.</p>
                                </div>
                            </div>
                            <div id="chillChallengeContent" class="chill-progress-body">
                                <div class="chill-progress-placeholder">Chillì´ ì±Œë¦°ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì—ìš”...</div>
                            </div>
                            <div class="chill-progress-footer" id="chillRankingNote">
                                <span>ë‚´ ìˆœìœ„ ë°ì´í„° ì¤€ë¹„ ì¤‘</span>
                                <a href="ranking.html" class="chill-ranking-link">ì „ì²´ ë­í‚¹ ë³´ê¸° â†’</a>
                            </div>
                        </div>

                        <div class="chill-side-card">
                            <h4>Chillì´ ì•Œë ¤ì£¼ëŠ” ì„¤ë¬¸ íŒ</h4>
                            <p>ì •í™•í•œ ë‹µì„ ì…ë ¥í• ìˆ˜ë¡, ìš°ë¦¬ ì§‘ì— ë”± ë§ëŠ” ì ˆì•½ í”Œëœì´ ì™„ì„±ë¼ìš”.</p>
                            <ul class="chill-side-list">
                                <li><span>ğŸ¥¶</span> ì—ì–´ì»¨Â·ë‚œë°© ì‚¬ìš©ëŸ‰ì„ ë– ì˜¬ë ¤ ë³´ì„¸ìš”.</li>
                                <li><span>ğŸ’¡</span> ì¡°ëª…ì´ LEDì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.</li>
                                <li><span>ğŸ§¾</span> ìµœê·¼ ì „ê¸°ìš”ê¸ˆ ê³ ì§€ì„œë¥¼ ì°¸ê³ í•˜ë©´ ë”ìš± ì •í™•í•´ìš”.</li>
                            </ul>
                            <div class="chill-side-badge">
                                <strong>TIP</strong>
                                <span>ì„¤ë¬¸ì„ ì €ì¥í•˜ë©´ ë§ˆì´í˜ì´ì§€ì—ì„œ ë‹¤ì‹œ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”.</span>
                            </div>
                        </div>

                        <div class="chill-side-card chill-data-card">
                            <h5>ğŸ“‹ ë°ì´í„° ì¶œì²˜ & ì‹ ë¢°ë„</h5>
                            <ul>
                                <li>í•œêµ­ì „ë ¥ê³µì‚¬ 2023ë…„ ì§€ì—­ë³„ ì „ë ¥ ì‚¬ìš©ëŸ‰ í†µê³„</li>
                                <li>ê³„ì ˆë³„ ì „ë ¥ ìˆ˜ìš” íŒ¨í„´ ë°˜ì˜ (ë´„Â·ì—¬ë¦„Â·ê°€ì„Â·ê²¨ìš¸)</li>
                                <li>ì„¤ë¬¸ ì‘ë‹µ ê¸°ë°˜ ë§ì¶¤ ë³´ì •, ì‹ ë¢°ë„ 85%</li>
                                <li>ì‹¤ì œ ìƒí™œ íŒ¨í„´ì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆì–´ìš”</li>
                            </ul>
                        </div>

                        <div class="chill-side-card chill-next-card">
                            <h5>ë‹¤ìŒ ë‹¨ê³„ ë¯¸ë¦¬ë³´ê¸°</h5>
                            <div class="chill-next-item">
                                <span>1</span>
                                <div>
                                    <strong>ì„¤ë¬¸ ì œì¶œ</strong>
                                    <p>Chillì—ê²Œ í•„ìš”í•œ ì •ë³´ ì „ë‹¬</p>
                                </div>
                            </div>
                            <div class="chill-next-item">
                                <span>2</span>
                                <div>
                                    <strong>ì˜ˆì¸¡ ë¦¬í¬íŠ¸ í™•ì¸</strong>
                                    <p>ìš°ë¦¬ ì§‘ ì˜ˆìƒ ì‚¬ìš©ëŸ‰ & ì ˆì•½ ì ì¬ë ¥</p>
                                </div>
                            </div>
                            <div class="chill-next-item">
                                <span>3</span>
                                <div>
                                    <strong>ë§ì¶¤ ë¯¸ì…˜ ì¶”ì²œ</strong>
                                    <p>ì§€ì›ê¸ˆÂ·ì ˆì•½ ì±Œë¦°ì§€ ìë™ ì—°ê²°</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.API_BASE_URL = window.API_BASE_URL || '';
    </script>
    <script src="js/common.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!user.id) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        async function loadChallengeStatus() {
            const cardContent = document.getElementById('chillChallengeContent');
            const rankingNote = document.getElementById('chillRankingNote');

            if (!user.id) {
                if (cardContent) {
                    cardContent.innerHTML = '<div class="chill-progress-empty">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. <a href="login.html">ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°</a></div>';
                    if (rankingNote) rankingNote.style.display = 'none';
                }
                return;
            }

            try {
                const response = await fetch(getApiUrl(`/api/challenge/user/${user.id}`));
                if (!response.ok) throw new Error('ì±Œë¦°ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                const data = await response.json();

                if (data.success && data.challenge) {
                    const challenge = data.challenge;
                    const saved = challenge.savedKwh || challenge.savedAmount || 0;
                    const target = challenge.targetKwh || challenge.targetAmount || 0;
                    const rate = Math.min(200, Math.round(challenge.achievementRate || (target ? (saved / target) * 100 : 0)));
                    const remaining = Math.max(0, target - saved);

                    const weekly = Array.isArray(data.weeklyProgress) ? data.weeklyProgress.find(item => item.isCurrent) : null;
                    const currentWindow = weekly ? `${weekly.weekLabel} Â· ${weekly.weekStart} ~ ${weekly.weekEnd}` : '';

                    const html = `
                        <div class="chill-progress-stats">
                            <div>
                                <span class="label">ë¯¸ì…˜ ìœ í˜•</span>
                                <strong>${challenge.type === 'monthly' ? 'ì›”ê°„ ì±Œë¦°ì§€' : 'ì£¼ê°„ ì±Œë¦°ì§€'}</strong>
                            </div>
                            <div>
                                <span class="label">ëˆ„ì  ì ˆì•½ëŸ‰</span>
                                <strong>${saved.toLocaleString()} kWh</strong>
                            </div>
                            <div>
                                <span class="label">ëª©í‘œ ëŒ€ë¹„</span>
                                <strong>${rate}%</strong>
                            </div>
                        </div>
                        <div class="chill-progress-bar">
                            <div class="chill-progress-fill" style="width: ${Math.min(rate, 100)}%"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">${saved.toLocaleString()} kWh / ${target.toLocaleString()} kWh</small>
                            <small class="text-muted">ë‚¨ì€ ëª©í‘œ ${remaining > 0 ? remaining.toLocaleString() + ' kWh' : 'ë‹¬ì„± ì™„ë£Œ!'}</small>
                        </div>
                        <div class="chill-progress-meta">
                            <div>
                                <span class="label">í˜„ì¬ ë‹¨ê³„</span>
                                <strong>${currentWindow || 'ì§„í–‰ ê¸°ê°„ ê³„ì‚° ì¤‘'}</strong>
                            </div>
                            <div>
                                <span class="label">ë³´ìœ  í¬ì¸íŠ¸</span>
                                <strong>${(data.points || 0).toLocaleString()}P</strong>
                            </div>
                            <div>
                                <span class="label">íšë“ ë°°ì§€</span>
                                <strong>${Array.isArray(data.badges) ? data.badges.length : 0}ê°œ</strong>
                            </div>
                        </div>
                    `;

                    if (cardContent) {
                        cardContent.innerHTML = html;
                    }

                    if (rankingNote) {
                        rankingNote.innerHTML = `
                            <span class="chill-ranking-text">ë‚´ ìˆœìœ„ëŠ” ì±Œë¦°ì§€ ì§„í–‰ í›„ ì—…ë°ì´íŠ¸ë¼ìš”.</span>
                            <a href="ranking.html" class="chill-ranking-link">ì „ì²´ ë­í‚¹ ë³´ê¸° â†’</a>
                        `;
                    }
                } else {
                    if (cardContent) {
                        cardContent.innerHTML = `
                            <div class="chill-progress-empty">
                                ì•„ì§ ì§„í–‰ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ì–´ìš”.<br>
                                <a href="challenge.html">ìƒˆ ì±Œë¦°ì§€ ì‹œì‘í•˜ëŸ¬ ê°€ê¸° â†’</a>
                            </div>
                        `;
                    }
                    if (rankingNote) rankingNote.style.display = 'none';
                }
            } catch (error) {
                if (cardContent) {
                    cardContent.innerHTML = `<div class="chill-progress-empty">ì±Œë¦°ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>`;
                }
                if (rankingNote) rankingNote.style.display = 'none';
            }
        }

        // ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
        async function previewPrediction() {
            const userProfile = {
                region: document.getElementById('region').value,
                housingType: document.getElementById('housingType').value,
                area: parseFloat(document.getElementById('area').value) || 30,
                householdSize: parseInt(document.getElementById('householdSize').value) || 4
            };

            const surveyAnswers = {
                aircon: document.getElementById('aircon').value,
                heating: document.getElementById('heating').value,
                lighting: document.getElementById('lighting').value,
                appliances: document.getElementById('appliances').value
            };

            if (!userProfile.region || !userProfile.housingType) {
                alert('ê¸°ë³¸ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(getApiUrl('/api/user/survey'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        userProfile,
                        surveyAnswers
                    })
                });

                const data = await response.json();

                if (data.success && data.prediction) {
                    const pred = data.prediction;
                    document.getElementById('predictionContent').innerHTML = `
                        <div class="row g-3">
                            <div class="col-6">
                                <strong>ì˜ˆìƒ ì‚¬ìš©ëŸ‰:</strong><br>
                                <span class="text-primary fw-bold">${pred.predictedUsage} kWh/ì›”</span>
                            </div>
                            <div class="col-6">
                                <strong>ì˜ˆìƒ ìš”ê¸ˆ:</strong><br>
                                <span class="text-success fw-bold">${pred.predictedCost.toLocaleString()}ì›/ì›”</span>
                            </div>
                            <div class="col-12">
                                <small class="text-muted">
                                    ì‹ ë¢°ë„: ${pred.confidence} | 
                                    ê¸°ì¤€: ${pred.dataSource} | 
                                    ê³„ì ˆ: ${pred.season}<br>
                                    ${pred.disclaimer}
                                </small>
                            </div>
                        </div>
                    `;
                    document.getElementById('predictionPreview').style.display = 'block';
                }
            } catch (error) {
                alert('ì˜ˆì¸¡ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì„¤ë¬¸ ì œì¶œ
        document.getElementById('surveyForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userProfile = {
                region: document.getElementById('region').value,
                housingType: document.getElementById('housingType').value,
                area: parseFloat(document.getElementById('area').value) || 30,
                householdSize: parseInt(document.getElementById('householdSize').value) || 4
            };

            const surveyAnswers = {
                aircon: document.getElementById('aircon').value,
                heating: document.getElementById('heating').value,
                lighting: document.getElementById('lighting').value,
                appliances: document.getElementById('appliances').value
            };

            try {
                const response = await fetch(getApiUrl('/api/user/survey'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        userProfile,
                        surveyAnswers
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // ì‚¬ìš©ì ì •ë³´ localStorage ì—…ë°ì´íŠ¸
                    if (user.id) {
                        user.region = userProfile.region;
                        user.housingType = userProfile.housingType;
                        user.area = userProfile.area;
                        user.householdSize = userProfile.householdSize;
                        user.surveyAnswers = surveyAnswers;
                        localStorage.setItem('user', JSON.stringify(user));
                    }
                    
                    if (confirm('ì„¤ë¬¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        window.location.href = 'mypage.html';
                    } else {
                        window.location.href = 'challenge.html';
                    }
                } else {
                    alert(data.message || 'ì„¤ë¬¸ ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadChallengeStatus);
        } else {
            loadChallengeStatus();
        }
    </script>
</body>
</html>

