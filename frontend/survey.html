<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë„ˆì§€ ì‚¬ìš© ìŠµê´€ ì„¤ë¬¸ - ì—ë„ˆì§€ ì ˆì•½ í”Œë«í¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="index.html">âš¡ ì—ë„ˆì§€ì ˆì•½</a>
            <a href="challenge.html" class="text-muted">â† ì±Œë¦°ì§€ë¡œ</a>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-5">
                        <h2 class="fw-bold mb-4">ì—ë„ˆì§€ ì‚¬ìš© ìŠµê´€ ì„¤ë¬¸</h2>
                        <p class="text-muted mb-4">
                            ì •í™•í•œ ì˜ˆì¸¡ì„ ìœ„í•´ ì—ë„ˆì§€ ì‚¬ìš© ìŠµê´€ì„ ì•Œë ¤ì£¼ì„¸ìš”.<br>
                            <small>ğŸ“Š ëª¨ë“  ë°ì´í„°ëŠ” í•œêµ­ì „ë ¥ê³µì‚¬ ê³µê°œ í†µê³„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</small>
                        </p>

                        <form id="surveyForm">
                            <!-- ê¸°ë³¸ ì •ë³´ -->
                            <div class="mb-4">
                                <h5 class="fw-bold mb-3">ê¸°ë³¸ ì •ë³´</h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">ê±°ì£¼ ì§€ì—­</label>
                                    <select class="form-select" id="region" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="ì„œìš¸">ì„œìš¸</option>
                                        <option value="ê²½ê¸°">ê²½ê¸°</option>
                                        <option value="ì¸ì²œ">ì¸ì²œ</option>
                                        <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                                        <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                                        <option value="ëŒ€ì „">ëŒ€ì „</option>
                                        <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                                        <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                                        <option value="ì„¸ì¢…">ì„¸ì¢…</option>
                                        <option value="ê²½ë¶">ê²½ë¶</option>
                                        <option value="ê²½ë‚¨">ê²½ë‚¨</option>
                                        <option value="ì¶©ë¶">ì¶©ë¶</option>
                                        <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
                                        <option value="ì „ë¶">ì „ë¶</option>
                                        <option value="ì „ë‚¨">ì „ë‚¨</option>
                                        <option value="ê°•ì›">ê°•ì›</option>
                                        <option value="ì œì£¼">ì œì£¼</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">ì£¼íƒ ìœ í˜•</label>
                                    <select class="form-select" id="housingType" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="ì•„íŒŒíŠ¸">ì•„íŒŒíŠ¸</option>
                                        <option value="ë‹¨ë…ì£¼íƒ">ë‹¨ë…ì£¼íƒ</option>
                                        <option value="ì˜¤í”¼ìŠ¤í…”">ì˜¤í”¼ìŠ¤í…”</option>
                                    </select>
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">ë©´ì  (í‰)</label>
                                        <input type="number" class="form-control" id="area" placeholder="ì˜ˆ: 30" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ê°€ì¡± ìˆ˜</label>
                                        <input type="number" class="form-control" id="householdSize" placeholder="ì˜ˆ: 4" min="1" max="10" required>
                                    </div>
                                </div>
                            </div>

                            <!-- ì—ë„ˆì§€ ì‚¬ìš© ìŠµê´€ -->
                            <div class="mb-4">
                                <h5 class="fw-bold mb-3">ì—ë„ˆì§€ ì‚¬ìš© ìŠµê´€</h5>

                                <div class="mb-3">
                                    <label class="form-label">ì—ì–´ì»¨ ì‚¬ìš© ë¹ˆë„</label>
                                    <select class="form-select" id="aircon" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="ê±°ì˜ ì‚¬ìš©ì•ˆí•¨">ê±°ì˜ ì‚¬ìš©ì•ˆí•¨</option>
                                        <option value="ê°€ë” ì‚¬ìš©">ê°€ë” ì‚¬ìš©</option>
                                        <option value="ìì£¼ ì‚¬ìš©">ìì£¼ ì‚¬ìš©</option>
                                        <option value="ê±°ì˜ í•­ìƒ">ê±°ì˜ í•­ìƒ</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë‚œë°© ë°©ì‹</label>
                                    <select class="form-select" id="heating" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="ë„ì‹œê°€ìŠ¤">ë„ì‹œê°€ìŠ¤</option>
                                        <option value="ì „ê¸°íˆí„°">ì „ê¸°íˆí„°</option>
                                        <option value="ì§€ì—­ë‚œë°©">ì§€ì—­ë‚œë°©</option>
                                        <option value="ê¸°ë¦„ë³´ì¼ëŸ¬">ê¸°ë¦„ë³´ì¼ëŸ¬</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">ì¡°ëª… ì‚¬ìš© í˜„í™©</label>
                                    <select class="form-select" id="lighting" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="í˜•ê´‘ë“± ìœ„ì£¼">í˜•ê´‘ë“± ìœ„ì£¼</option>
                                        <option value="LED ì¼ë¶€">LED ì¼ë¶€</option>
                                        <option value="LED ëŒ€ë¶€ë¶„">LED ëŒ€ë¶€ë¶„</option>
                                        <option value="LED ì „ë¶€">LED ì „ë¶€</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">ê°€ì „ì œí’ˆ ì‚¬ìš©ëŸ‰</label>
                                    <select class="form-select" id="appliances" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="ì ìŒ">ì ìŒ</option>
                                        <option value="ë³´í†µ">ë³´í†µ</option>
                                        <option value="ë§ìŒ">ë§ìŒ</option>
                                    </select>
                                </div>
                            </div>

                            <!-- ì˜ˆì¸¡ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
                            <div class="alert alert-light border mb-4" id="predictionPreview" style="display: none;">
                                <h6 class="fw-bold mb-2">ğŸ“Š ì˜ˆì¸¡ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h6>
                                <div id="predictionContent"></div>
                            </div>

                            <div class="d-flex gap-3">
                                <button type="submit" class="btn btn-primary btn-lg flex-fill">
                                    ì„¤ë¬¸ ì œì¶œí•˜ê¸°
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="previewPrediction()">
                                    ë¯¸ë¦¬ë³´ê¸°
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- ë°ì´í„° ì¶œì²˜ ì•ˆë‚´ -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-body p-4">
                        <h6 class="fw-bold mb-3">ğŸ“‹ ë°ì´í„° ì¶œì²˜ ë° ì‹ ë¢°ë„</h6>
                        <ul class="mb-0 small text-muted">
                            <li>ê¸°ì¤€ ë°ì´í„°: í•œêµ­ì „ë ¥ê³µì‚¬ 2023ë…„ ì§€ì—­ë³„ í‰ê·  ì „ë ¥ ì‚¬ìš©ëŸ‰ í†µê³„</li>
                            <li>ì˜ˆì¸¡ ì‹ ë¢°ë„: 85% (ì§€ì—­ë³„ í‰ê·  ë°ì´í„° + ì„¤ë¬¸ ì‘ë‹µ ë°˜ì˜)</li>
                            <li>ê³„ì ˆë³„ ë³€ë™: í•œì „ ê³„ì ˆë³„ ì „ë ¥ ìˆ˜ìš” íŒ¨í„´ ë°˜ì˜</li>
                            <li>í•œê³„: ì‹¤ì œ ìƒí™œíŒ¨í„´ì— ë”°ë¼ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!user.id) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        // ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
        async function previewPrediction() {
            const userProfile = {
                region: document.getElementById('region').value,
                housingType: document.getElementById('housingType').value,
                area: parseFloat(document.getElementById('area').value) || 30,
                householdSize: parseInt(document.getElementById('householdSize').value) || 4
            };

            const surveyAnswers = {
                aircon: document.getElementById('aircon').value,
                heating: document.getElementById('heating').value,
                lighting: document.getElementById('lighting').value,
                appliances: document.getElementById('appliances').value
            };

            if (!userProfile.region || !userProfile.housingType) {
                alert('ê¸°ë³¸ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/user/survey', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        userProfile,
                        surveyAnswers
                    })
                });

                const data = await response.json();

                if (data.success && data.prediction) {
                    const pred = data.prediction;
                    document.getElementById('predictionContent').innerHTML = `
                        <div class="row g-3">
                            <div class="col-6">
                                <strong>ì˜ˆìƒ ì‚¬ìš©ëŸ‰:</strong><br>
                                <span class="text-primary fw-bold">${pred.predictedUsage} kWh/ì›”</span>
                            </div>
                            <div class="col-6">
                                <strong>ì˜ˆìƒ ìš”ê¸ˆ:</strong><br>
                                <span class="text-success fw-bold">${pred.predictedCost.toLocaleString()}ì›/ì›”</span>
                            </div>
                            <div class="col-12">
                                <small class="text-muted">
                                    ì‹ ë¢°ë„: ${pred.confidence} | 
                                    ê¸°ì¤€: ${pred.dataSource} | 
                                    ê³„ì ˆ: ${pred.season}<br>
                                    ${pred.disclaimer}
                                </small>
                            </div>
                        </div>
                    `;
                    document.getElementById('predictionPreview').style.display = 'block';
                }
            } catch (error) {
                alert('ì˜ˆì¸¡ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì„¤ë¬¸ ì œì¶œ
        document.getElementById('surveyForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userProfile = {
                region: document.getElementById('region').value,
                housingType: document.getElementById('housingType').value,
                area: parseFloat(document.getElementById('area').value) || 30,
                householdSize: parseInt(document.getElementById('householdSize').value) || 4
            };

            const surveyAnswers = {
                aircon: document.getElementById('aircon').value,
                heating: document.getElementById('heating').value,
                lighting: document.getElementById('lighting').value,
                appliances: document.getElementById('appliances').value
            };

            try {
                const response = await fetch('/api/user/survey', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        userProfile,
                        surveyAnswers
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // ì‚¬ìš©ì ì •ë³´ localStorage ì—…ë°ì´íŠ¸
                    if (user.id) {
                        user.region = userProfile.region;
                        user.housingType = userProfile.housingType;
                        user.area = userProfile.area;
                        user.householdSize = userProfile.householdSize;
                        user.surveyAnswers = surveyAnswers;
                        localStorage.setItem('user', JSON.stringify(user));
                    }
                    
                    if (confirm('ì„¤ë¬¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        window.location.href = 'mypage.html';
                    } else {
                        window.location.href = 'challenge.html';
                    }
                } else {
                    alert(data.message || 'ì„¤ë¬¸ ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    </script>
</body>
</html>

