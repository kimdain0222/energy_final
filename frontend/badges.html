<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë±ƒì§€ êµ¬ê²½í•˜ê¸° - ì—ë„ˆì§€ ì ˆì•½ í”Œë«í¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes sparkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .badge-card {
            transition: all 0.3s ease;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }
        .badge-card.earned {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: pulse 2s infinite;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        .badge-card.next-challenge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: 3px solid #fff;
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
        }
        .badge-card.locked {
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
            color: #757575;
            filter: grayscale(0.8);
        }
        .badge-icon {
            font-size: 3rem;
            animation: bounce 2s infinite;
        }
        .badge-card.earned .badge-icon {
            filter: drop-shadow(0 5px 15px rgba(255, 255, 255, 0.5));
        }
        .sparkle {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1.2rem;
            animation: sparkle 1.5s infinite;
        }
        .celebration-section {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(252, 182, 159, 0.3);
        }
        .challenge-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 50px;
            color: white;
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
        }
        .challenge-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.6);
            color: white;
        }
        .section-title {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        .congrats-emoji {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 10px;
        }
        .badge-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin: 10px 0 8px;
        }
        .badge-description {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .badge-condition {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
        }
        .badge-card.locked .badge-condition {
            background: rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="index.html">ğŸƒ ecosync</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">ëŒ€ì‹œë³´ë“œ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="challenge.html">ì±Œë¦°ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ranking.html">ë­í‚¹</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="programs.html">ì§€ì›ì‚¬ì—…</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <h1 class="text-center fw-bold mb-5">ğŸ† ë±ƒì§€ êµ¬ê²½í•˜ê¸°</h1>

        <!-- ì¶•í•˜ ì„¹ì…˜ - íšë“í•œ ë±ƒì§€ê°€ ìˆì„ ë•Œ -->
        <div id="celebrationSection" class="celebration-section" style="display: none;">
            <span class="congrats-emoji">ğŸ‰</span>
            <h3 class="fw-bold mb-3">ì¶•í•˜í•´ìš”! ë©‹ì§„ ë±ƒì§€ë¥¼ íšë“í•˜ì…¨ë„¤ìš”! ğŸŠ</h3>
            <p class="lead">ì•„ë˜ì—ì„œ íšë“í•œ ë±ƒì§€ì™€ ë‹¤ìŒ ë„ì „ ë±ƒì§€ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</p>
        </div>

        <!-- ë‹¤ìŒ ë„ì „ ë±ƒì§€ ì„¹ì…˜ -->
        <div id="nextChallengeSection" class="mb-5" style="display: none;">
            <h2 class="section-title">ğŸŒŸ ë‹¤ìŒ ë±ƒì§€ì— ë„ì „í•´ë³´ì„¸ìš”!</h2>
            <div class="row g-4 mb-4">
                <div class="col-md-6 mx-auto">
                    <div id="nextBadgeCard" class="badge-card next-challenge p-4 text-center">
                        <span class="sparkle">âœ¨</span>
                        <div id="nextBadgeIcon" class="badge-icon mb-3"></div>
                        <div id="nextBadgeName" class="badge-name"></div>
                        <div id="nextBadgeDescription" class="badge-description"></div>
                        <div id="nextBadgeCondition" class="badge-condition"></div>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <a href="challenge.html" class="challenge-button">ì´ ë±ƒì§€ íšë“í•˜ëŸ¬ ê°€ê¸°! ğŸš€</a>
            </div>
        </div>

        <!-- íšë“í•œ ë±ƒì§€ ì„¹ì…˜ -->
        <div id="earnedBadgesSection" class="mb-5">
            <h2 class="section-title">ğŸ–ï¸ íšë“í•œ ë±ƒì§€</h2>
            <div id="earnedBadges" class="row g-4">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>

        <!-- ëª¨ë“  ë±ƒì§€ ì„¹ì…˜ -->
        <div id="allBadgesSection">
            <h2 class="section-title">ğŸ“š ì „ì²´ ë±ƒì§€ ëª©ë¡</h2>
            <div id="allBadges" class="row g-4">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.API_BASE_URL = window.API_BASE_URL || '';
    </script>
    <script src="js/common.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!user.id) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        let allBadges = [];
        let userBadgeIds = [];

        // ë±ƒì§€ ë‚œì´ë„ ìˆœì„œ ì •ì˜ (íšë“í•˜ê¸° ì‰¬ìš´ ìˆœì„œ)
        const badgeOrder = [
            // ê¸°ë³¸
            'badge000', // ì‹œì‘ì˜ ë°œê±¸ìŒ (íšŒì›ê°€ì…)
            'badge001', // ì²« ì ˆì•½
            // ì ˆì•½ëŸ‰ ê¸°ë°˜
            'badge008', // ìƒˆì‹¹ ì ˆì•½ (10kWh)
            'badge006', // 50kWh í´ëŸ½
            'badge002', // ì—ë„ˆì§€ ë§ˆìŠ¤í„° (100kWh)
            'badge009', // 200kWh í´ëŸ½
            'badge010', // íƒ„ì†Œ ì œë¡œ íˆì–´ë¡œ (500kWh)
            'badge011', // ì ˆì•½ ë ˆì „ë“œ (1000kWh)
            // ë‹¬ì„±ë¥  ê¸°ë°˜
            'badge012', // ì™„ë²½ ë‹¬ì„± (100%)
            'badge013', // ìš°ìˆ˜ ë‹¬ì„± (120%)
            'badge007', // ëª©í‘œ ë‹¬ì„±ì™• (150%)
            'badge014', // ì´ˆì›” ë‹¬ì„± (200%)
            // ì§€ì†ì„± ê¸°ë°˜
            'badge015', // ì£¼ê°„ ì°¸ì—¬ì (1ì£¼)
            'badge004', // ì§€ì†ì˜ ë‹¬ì¸ (4ì£¼)
            'badge016', // ì¥ê¸° íŒŒì´í„° (8ì£¼)
            'badge017', // ì—°ì† ì±”í”¼ì–¸ (12ì£¼)
            // ë­í‚¹ ê¸°ë°˜
            'badge003', // ì£¼ê°„ ì±”í”¼ì–¸ (ì£¼ê°„ 1ìœ„)
            'badge005', // ì§€ì—­ íˆì–´ë¡œ (ì§€ì—­ë³„ 1ìœ„)
            'badge018', // ì „êµ­ ì±”í”¼ì–¸ (ì „êµ­ 1ìœ„)
            'badge019', // 2ìœ„ ë‹¬ì„±
            'badge020', // 3ìœ„ ë‹¬ì„±
            'badge021', // ìƒìœ„ 10%
            // ì°¸ì—¬ í™œë™ ê¸°ë°˜
            'badge022', // ë§ì¶¤í˜• ì„¤ë¬¸ ì™„ë£Œ
            'badge023', // ë¶„ì„ ë§ˆìŠ¤í„° (5íšŒ ì´ìƒ)
            'badge024', // ì§€ì›ì‚¬ì—… íƒí—˜ê°€ (10ê°œ ì´ìƒ)
            'badge025', // ì»¤ë®¤ë‹ˆí‹° ì°¸ì—¬ì (10íšŒ ì´ìƒ)
            // íŠ¹ë³„ ì´ë²¤íŠ¸ ê¸°ë°˜
            'badge026', // ì²«ë‚  ì™„ë²½
            'badge027', // ë³´ë„ˆìŠ¤ í€˜ìŠ¤íŠ¸ (ì›”ê°„ ì±Œë¦°ì§€ ì™„ë£Œ)
            'badge028', // ë ˆì¸ë³´ìš° (ëª¨ë“  ê¸°ë³¸ ë°°ì§€)
            'badge029'  // ë°ì¼ë¦¬ ì±Œë¦°ì € (7ì¼ ì—°ì†)
        ];

        // í˜ì´ì§€ ì´ˆê¸°í™”
        async function init() {
            await loadUserBadges();
            await loadAllBadges();
            displayBadges();
            findNextChallengeBadge();
        }

        // ì‚¬ìš©ì ë±ƒì§€ ë¡œë“œ
        async function loadUserBadges() {
            try {
                const response = await fetch(getApiUrl(`/api/challenge/user/${user.id}`));
                const data = await response.json();
                
                if (data.success && data.badges) {
                    userBadgeIds = data.badges || [];
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ë±ƒì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ì „ì²´ ë±ƒì§€ ëª©ë¡ ë¡œë“œ
        async function loadAllBadges() {
            try {
                const response = await fetch(getApiUrl('/api/badges'));
                const data = await response.json();
                
                if (data.success) {
                    allBadges = data.badges || [];
                    // ë±ƒì§€ ìˆœì„œ ì •ë ¬
                    allBadges.sort((a, b) => {
                        const indexA = badgeOrder.indexOf(a.id);
                        const indexB = badgeOrder.indexOf(b.id);
                        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
                    });
                }
            } catch (error) {
                console.error('ë±ƒì§€ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ë±ƒì§€ í‘œì‹œ
        function displayBadges() {
            // ì•ˆì „ ì²´í¬
            if (!allBadges || allBadges.length === 0) {
                document.getElementById('allBadgesSection').innerHTML = '<p class="text-center text-muted">ë±ƒì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
                return;
            }

            if (!userBadgeIds || !Array.isArray(userBadgeIds)) {
                userBadgeIds = [];
            }

            const earnedBadges = allBadges.filter(badge => userBadgeIds.includes(badge.id));
            const lockedBadges = allBadges.filter(badge => !userBadgeIds.includes(badge.id));

            // íšë“í•œ ë±ƒì§€ ì„¹ì…˜
            if (earnedBadges.length > 0) {
                document.getElementById('celebrationSection').style.display = 'block';
                document.getElementById('earnedBadgesSection').style.display = 'block';
                
                document.getElementById('earnedBadges').innerHTML = earnedBadges.map(badge => `
                    <div class="col-md-4 col-6">
                        <div class="badge-card earned p-3 text-center h-100">
                            <div class="badge-icon">${badge.icon}</div>
                            <div class="badge-name">${badge.name}</div>
                            <div class="badge-description">${badge.description}</div>
                            <div class="badge-condition">${badge.condition}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('earnedBadgesSection').innerHTML = `
                    <div class="text-center py-5">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸŒ±</div>
                        <h4 class="text-muted">ì•„ì§ íšë“í•œ ë±ƒì§€ê°€ ì—†ì–´ìš”</h4>
                        <p class="text-muted">ì±Œë¦°ì§€ë¥¼ ì‹œì‘í•˜ê³  ì²« ë±ƒì§€ë¥¼ íšë“í•´ë³´ì„¸ìš”!</p>
                        <a href="challenge.html" class="btn btn-primary btn-lg mt-3">ì²« ì±Œë¦°ì§€ ì‹œì‘í•˜ê¸° ğŸš€</a>
                    </div>
                `;
            }

            // ì¹´í…Œê³ ë¦¬ë³„ ë±ƒì§€ ë¶„ë¥˜
            const categories = {
                'ê¸°ë³¸': ['badge000', 'badge001'],
                'ì ˆì•½ëŸ‰ ê¸°ë°˜': ['badge008', 'badge006', 'badge002', 'badge009', 'badge010', 'badge011'],
                'ë‹¬ì„±ë¥  ê¸°ë°˜': ['badge012', 'badge013', 'badge007', 'badge014'],
                'ì§€ì†ì„± ê¸°ë°˜': ['badge015', 'badge004', 'badge016', 'badge017'],
                'ë­í‚¹ ê¸°ë°˜': ['badge003', 'badge005', 'badge018', 'badge019', 'badge020', 'badge021'],
                'ì°¸ì—¬ í™œë™ ê¸°ë°˜': ['badge022', 'badge023', 'badge024', 'badge025'],
                'íŠ¹ë³„ ì´ë²¤íŠ¸ ê¸°ë°˜': ['badge026', 'badge027', 'badge028', 'badge029']
            };

            const categoryNames = {
                'ê¸°ë³¸': 'ğŸŒŸ ê¸°ë³¸',
                'ì ˆì•½ëŸ‰ ê¸°ë°˜': 'ğŸ’š ì ˆì•½ëŸ‰ ê¸°ë°˜',
                'ë‹¬ì„±ë¥  ê¸°ë°˜': 'ğŸ¯ ë‹¬ì„±ë¥  ê¸°ë°˜',
                'ì§€ì†ì„± ê¸°ë°˜': 'ğŸ”¥ ì§€ì†ì„± ê¸°ë°˜',
                'ë­í‚¹ ê¸°ë°˜': 'ğŸ† ë­í‚¹ ê¸°ë°˜',
                'ì°¸ì—¬ í™œë™ ê¸°ë°˜': 'ğŸ“Š ì°¸ì—¬ í™œë™ ê¸°ë°˜',
                'íŠ¹ë³„ ì´ë²¤íŠ¸ ê¸°ë°˜': 'âœ¨ íŠ¹ë³„ ì´ë²¤íŠ¸ ê¸°ë°˜'
            };

            // ì¹´í…Œê³ ë¦¬ë³„ë¡œ HTML ìƒì„±
            let allBadgesHtml = '';
            Object.keys(categories).forEach(categoryName => {
                const categoryBadgeIds = categories[categoryName];
                const categoryBadges = allBadges.filter(badge => categoryBadgeIds.includes(badge.id));
                
                if (categoryBadges.length > 0) {
                    const categoryDisplayName = categoryNames[categoryName] || categoryName;
                    allBadgesHtml += `
                        <div class="mb-5">
                            <h3 class="fw-bold mb-4" style="font-size: 1.5rem; color: #495057;">
                                ${categoryDisplayName}
                                <small class="text-muted" style="font-size: 0.9rem;">
                                    (${categoryBadges.filter(b => userBadgeIds.includes(b.id)).length}/${categoryBadges.length} íšë“)
                                </small>
                            </h3>
                            <div class="row g-4">
                                ${categoryBadges.map(badge => {
                                    const hasBadge = userBadgeIds.includes(badge.id);
                                    return `
                                        <div class="col-md-4 col-6">
                                            <div class="badge-card ${hasBadge ? 'earned' : 'locked'} p-3 text-center h-100">
                                                ${hasBadge ? '<span class="sparkle">âœ¨</span>' : ''}
                                                <div class="badge-icon" ${!hasBadge ? 'style="opacity: 0.5;"' : ''}>${badge.icon}</div>
                                                <div class="badge-name">${badge.name}</div>
                                                <div class="badge-description">${badge.description}</div>
                                                <div class="badge-condition">${badge.condition}</div>
                                                ${hasBadge ? '<div class="mt-3"><span class="badge bg-success" style="font-size: 0.9rem;">íšë“ ì™„ë£Œ! ğŸ‰</span></div>' : '<div class="mt-3"><span class="badge bg-secondary" style="font-size: 0.9rem;">ë¯¸íšë“</span></div>'}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            document.getElementById('allBadges').innerHTML = allBadgesHtml || '<p class="text-center text-muted">ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // ë‹¤ìŒ ë„ì „ ë±ƒì§€ ì°¾ê¸°
        function findNextChallengeBadge() {
            if (!userBadgeIds || !Array.isArray(userBadgeIds)) {
                userBadgeIds = [];
            }
            
            if (!allBadges || allBadges.length === 0) {
                return;
            }

            // ë±ƒì§€ ìˆœì„œëŒ€ë¡œ í™•ì¸í•˜ì—¬ íšë“í•˜ì§€ ì•Šì€ ì²« ë²ˆì§¸ ë±ƒì§€ ì°¾ê¸°
            for (const badgeId of badgeOrder) {
                if (!userBadgeIds.includes(badgeId)) {
                    const nextBadge = allBadges.find(b => b.id === badgeId);
                    if (nextBadge) {
                        displayNextChallengeBadge(nextBadge);
                        return;
                    }
                }
            }

            // ëª¨ë“  ë±ƒì§€ë¥¼ íšë“í•œ ê²½ìš°
            if (userBadgeIds.length === allBadges.length) {
                document.getElementById('nextChallengeSection').innerHTML = `
                    <div class="text-center py-5">
                        <div style="font-size: 5rem; margin-bottom: 20px;">ğŸ†</div>
                        <h3 class="fw-bold mb-3">ì¶•í•˜í•©ë‹ˆë‹¤! ğŸŠ</h3>
                        <p class="lead">ëª¨ë“  ë±ƒì§€ë¥¼ íšë“í•˜ì…¨ë„¤ìš”! ì •ë§ ëŒ€ë‹¨í•´ìš”!</p>
                        <p class="text-muted">ê³„ì†í•´ì„œ ì—ë„ˆì§€ ì ˆì•½ì— ë„ì „í•´ë³´ì„¸ìš”! ğŸŒ±</p>
                    </div>
                `;
                document.getElementById('nextChallengeSection').style.display = 'block';
            }
        }

        // ë‹¤ìŒ ë„ì „ ë±ƒì§€ í‘œì‹œ
        function displayNextChallengeBadge(badge) {
            document.getElementById('nextChallengeSection').style.display = 'block';
            document.getElementById('nextBadgeIcon').textContent = badge.icon;
            document.getElementById('nextBadgeName').textContent = badge.name;
            document.getElementById('nextBadgeDescription').textContent = badge.description;
            document.getElementById('nextBadgeCondition').textContent = badge.condition;
        }

        // ì´ˆê¸°í™”
        init();
    </script>
</body>
</html>

