<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë±ƒì§€ êµ¬ê²½í•˜ê¸° - ì—ë„ˆì§€ ì ˆì•½ í”Œë«í¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes sparkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .badge-card {
            transition: all 0.3s ease;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }
        .badge-card.earned {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: pulse 2s infinite;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        .badge-card.next-challenge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: 3px solid #fff;
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
        }
        .badge-card.locked {
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
            color: #757575;
            filter: grayscale(0.8);
        }
        .badge-icon {
            font-size: 5rem;
            animation: bounce 2s infinite;
        }
        .badge-card.earned .badge-icon {
            filter: drop-shadow(0 5px 15px rgba(255, 255, 255, 0.5));
        }
        .sparkle {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            animation: sparkle 1.5s infinite;
        }
        .celebration-section {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(252, 182, 159, 0.3);
        }
        .challenge-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            color: white;
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
        }
        .challenge-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.6);
            color: white;
        }
        .section-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        .congrats-emoji {
            font-size: 3rem;
            display: block;
            margin-bottom: 15px;
        }
        .badge-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 15px 0 10px;
        }
        .badge-description {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        .badge-condition {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
        }
        .badge-card.locked .badge-condition {
            background: rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="index.html">âš¡ ì—ë„ˆì§€ì ˆì•½</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">ëŒ€ì‹œë³´ë“œ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="challenge.html">ì±Œë¦°ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ranking.html">ë­í‚¹</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="programs.html">ì§€ì›ì‚¬ì—…</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <h1 class="text-center fw-bold mb-5">ğŸ† ë±ƒì§€ êµ¬ê²½í•˜ê¸°</h1>

        <!-- ì¶•í•˜ ì„¹ì…˜ - íšë“í•œ ë±ƒì§€ê°€ ìˆì„ ë•Œ -->
        <div id="celebrationSection" class="celebration-section" style="display: none;">
            <span class="congrats-emoji">ğŸ‰</span>
            <h3 class="fw-bold mb-3">ì¶•í•˜í•´ìš”! ë©‹ì§„ ë±ƒì§€ë¥¼ íšë“í•˜ì…¨ë„¤ìš”! ğŸŠ</h3>
            <p class="lead">ì•„ë˜ì—ì„œ íšë“í•œ ë±ƒì§€ì™€ ë‹¤ìŒ ë„ì „ ë±ƒì§€ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</p>
        </div>

        <!-- ë‹¤ìŒ ë„ì „ ë±ƒì§€ ì„¹ì…˜ -->
        <div id="nextChallengeSection" class="mb-5" style="display: none;">
            <h2 class="section-title">ğŸŒŸ ë‹¤ìŒ ë±ƒì§€ì— ë„ì „í•´ë³´ì„¸ìš”!</h2>
            <div class="row g-4 mb-4">
                <div class="col-md-6 mx-auto">
                    <div id="nextBadgeCard" class="badge-card next-challenge p-5 text-center">
                        <span class="sparkle">âœ¨</span>
                        <div id="nextBadgeIcon" class="badge-icon mb-3"></div>
                        <div id="nextBadgeName" class="badge-name"></div>
                        <div id="nextBadgeDescription" class="badge-description"></div>
                        <div id="nextBadgeCondition" class="badge-condition"></div>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <a href="challenge.html" class="challenge-button">ì´ ë±ƒì§€ íšë“í•˜ëŸ¬ ê°€ê¸°! ğŸš€</a>
            </div>
        </div>

        <!-- íšë“í•œ ë±ƒì§€ ì„¹ì…˜ -->
        <div id="earnedBadgesSection" class="mb-5">
            <h2 class="section-title">ğŸ–ï¸ íšë“í•œ ë±ƒì§€</h2>
            <div id="earnedBadges" class="row g-4">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>

        <!-- ëª¨ë“  ë±ƒì§€ ì„¹ì…˜ -->
        <div id="allBadgesSection">
            <h2 class="section-title">ğŸ“š ì „ì²´ ë±ƒì§€ ëª©ë¡</h2>
            <div id="allBadges" class="row g-4">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!user.id) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        let allBadges = [];
        let userBadgeIds = [];

        // ë±ƒì§€ ë‚œì´ë„ ìˆœì„œ ì •ì˜ (íšë“í•˜ê¸° ì‰¬ìš´ ìˆœì„œ)
        const badgeOrder = [
            'badge000', // ì‹œì‘ì˜ ë°œê±¸ìŒ (íšŒì›ê°€ì…)
            'badge001', // ì²« ì ˆì•½
            'badge006', // 50kWh í´ëŸ½
            'badge007', // ëª©í‘œ ë‹¬ì„±ì™•
            'badge002', // ì—ë„ˆì§€ ë§ˆìŠ¤í„° 100kWh
            'badge004', // ì§€ì†ì˜ ë‹¬ì¸
            'badge003', // ì£¼ê°„ ì±”í”¼ì–¸
            'badge005'  // ì§€ì—­ íˆì–´ë¡œ
        ];

        // í˜ì´ì§€ ì´ˆê¸°í™”
        async function init() {
            await loadUserBadges();
            await loadAllBadges();
            displayBadges();
            findNextChallengeBadge();
        }

        // ì‚¬ìš©ì ë±ƒì§€ ë¡œë“œ
        async function loadUserBadges() {
            try {
                const response = await fetch(`/api/challenge/user/${user.id}`);
                const data = await response.json();
                
                if (data.success && data.badges) {
                    userBadgeIds = data.badges || [];
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ë±ƒì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ì „ì²´ ë±ƒì§€ ëª©ë¡ ë¡œë“œ
        async function loadAllBadges() {
            try {
                const response = await fetch('/api/badges');
                const data = await response.json();
                
                if (data.success) {
                    allBadges = data.badges || [];
                    // ë±ƒì§€ ìˆœì„œ ì •ë ¬
                    allBadges.sort((a, b) => {
                        const indexA = badgeOrder.indexOf(a.id);
                        const indexB = badgeOrder.indexOf(b.id);
                        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
                    });
                }
            } catch (error) {
                console.error('ë±ƒì§€ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ë±ƒì§€ í‘œì‹œ
        function displayBadges() {
            const earnedBadges = allBadges.filter(badge => userBadgeIds.includes(badge.id));
            const lockedBadges = allBadges.filter(badge => !userBadgeIds.includes(badge.id));

            // íšë“í•œ ë±ƒì§€ ì„¹ì…˜
            if (earnedBadges.length > 0) {
                document.getElementById('celebrationSection').style.display = 'block';
                document.getElementById('earnedBadgesSection').style.display = 'block';
                
                document.getElementById('earnedBadges').innerHTML = earnedBadges.map(badge => `
                    <div class="col-md-4 col-6">
                        <div class="badge-card earned p-4 text-center h-100">
                            <div class="badge-icon">${badge.icon}</div>
                            <div class="badge-name">${badge.name}</div>
                            <div class="badge-description">${badge.description}</div>
                            <div class="badge-condition">${badge.condition}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('earnedBadgesSection').innerHTML = `
                    <div class="text-center py-5">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸŒ±</div>
                        <h4 class="text-muted">ì•„ì§ íšë“í•œ ë±ƒì§€ê°€ ì—†ì–´ìš”</h4>
                        <p class="text-muted">ì±Œë¦°ì§€ë¥¼ ì‹œì‘í•˜ê³  ì²« ë±ƒì§€ë¥¼ íšë“í•´ë³´ì„¸ìš”!</p>
                        <a href="challenge.html" class="btn btn-primary btn-lg mt-3">ì²« ì±Œë¦°ì§€ ì‹œì‘í•˜ê¸° ğŸš€</a>
                    </div>
                `;
            }

            // ì „ì²´ ë±ƒì§€ ì„¹ì…˜
            document.getElementById('allBadges').innerHTML = allBadges.map(badge => {
                const hasBadge = userBadgeIds.includes(badge.id);
                return `
                    <div class="col-md-4 col-6">
                        <div class="badge-card ${hasBadge ? 'earned' : 'locked'} p-4 text-center h-100">
                            ${hasBadge ? '<span class="sparkle">âœ¨</span>' : ''}
                            <div class="badge-icon" ${!hasBadge ? 'style="opacity: 0.5;"' : ''}>${badge.icon}</div>
                            <div class="badge-name">${badge.name}</div>
                            <div class="badge-description">${badge.description}</div>
                            <div class="badge-condition">${badge.condition}</div>
                            ${hasBadge ? '<div class="mt-3"><span class="badge bg-success" style="font-size: 0.9rem;">íšë“ ì™„ë£Œ! ğŸ‰</span></div>' : '<div class="mt-3"><span class="badge bg-secondary" style="font-size: 0.9rem;">ë¯¸íšë“</span></div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ë‹¤ìŒ ë„ì „ ë±ƒì§€ ì°¾ê¸°
        function findNextChallengeBadge() {
            // ë±ƒì§€ ìˆœì„œëŒ€ë¡œ í™•ì¸í•˜ì—¬ íšë“í•˜ì§€ ì•Šì€ ì²« ë²ˆì§¸ ë±ƒì§€ ì°¾ê¸°
            for (const badgeId of badgeOrder) {
                if (!userBadgeIds.includes(badgeId)) {
                    const nextBadge = allBadges.find(b => b.id === badgeId);
                    if (nextBadge) {
                        displayNextChallengeBadge(nextBadge);
                        return;
                    }
                }
            }

            // ëª¨ë“  ë±ƒì§€ë¥¼ íšë“í•œ ê²½ìš°
            if (userBadgeIds.length === allBadges.length) {
                document.getElementById('nextChallengeSection').innerHTML = `
                    <div class="text-center py-5">
                        <div style="font-size: 5rem; margin-bottom: 20px;">ğŸ†</div>
                        <h3 class="fw-bold mb-3">ì¶•í•˜í•©ë‹ˆë‹¤! ğŸŠ</h3>
                        <p class="lead">ëª¨ë“  ë±ƒì§€ë¥¼ íšë“í•˜ì…¨ë„¤ìš”! ì •ë§ ëŒ€ë‹¨í•´ìš”!</p>
                        <p class="text-muted">ê³„ì†í•´ì„œ ì—ë„ˆì§€ ì ˆì•½ì— ë„ì „í•´ë³´ì„¸ìš”! ğŸŒ±</p>
                    </div>
                `;
                document.getElementById('nextChallengeSection').style.display = 'block';
            }
        }

        // ë‹¤ìŒ ë„ì „ ë±ƒì§€ í‘œì‹œ
        function displayNextChallengeBadge(badge) {
            document.getElementById('nextChallengeSection').style.display = 'block';
            document.getElementById('nextBadgeIcon').textContent = badge.icon;
            document.getElementById('nextBadgeName').textContent = badge.name;
            document.getElementById('nextBadgeDescription').textContent = badge.description;
            document.getElementById('nextBadgeCondition').textContent = badge.condition;
        }

        // ì´ˆê¸°í™”
        init();
    </script>
</body>
</html>

