<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë±ƒì§€ êµ¬ê²½í•˜ê¸° - ì—ë„ˆì§€ ì ˆì•½ í”Œë«í¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="aqua-theme">
    <nav class="navbar navbar-expand-lg aqua-navbar">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">ğŸƒ ecopass</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">ë¡œë¹„</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="programs.html">ì§€ì›ì‚¬ì—…</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="challenge.html">ì±Œë¦°ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ranking.html">ë­í‚¹</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="challenge-list.html">ê°™ì´í•´ìš”</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container aqua-hero">
        <div class="row align-items-center g-5">
            <div class="col-lg-6">
                <div class="aqua-pill">
                    <span role="img" aria-label="sparkles">ğŸ’§</span> Aquaì™€ í•¨ê»˜í•˜ëŠ” íë§ ë±ƒì§€ ì»¬ë ‰ì…˜
                </div>
                <h1>ì°¨ë¶„í•˜ê²Œ ëª¨ìœ¼ëŠ” <br>ì—ë„ˆì§€ ì ˆì•½ ë±ƒì§€ ì—¬í–‰</h1>
                <p class="lead">ë¬¼í† ë¼ Aquaê°€ ë‹¹ì‹ ì˜ ì ˆì•½ ì—¬ì •ì„ ë¶€ë“œëŸ½ê²Œ ì•ˆë‚´í•´ìš”. ë§ˆìŒì´ í¸ì•ˆí•´ì§€ëŠ” ìƒ‰ê°ê³¼ í•¨ê»˜ ì°¨ê·¼ì°¨ê·¼ ë±ƒì§€ë¥¼ ëª¨ì•„ë³´ì„¸ìš”.</p>
                <div class="aqua-cta-group">
                    <a href="challenge.html" class="btn btn-primary btn-lg">ìƒˆë¡œìš´ ì±Œë¦°ì§€ íƒìƒ‰í•˜ê¸°</a>
                    <a href="ranking.html" class="btn btn-outline btn-lg">ì»¤ë®¤ë‹ˆí‹° ë­í‚¹ ë³´ê¸°</a>
                </div>
                <div class="aqua-floating-filter">
                    <span class="chip primary-chip">íšë“í•œ ë±ƒì§€ <span id="earnedCountChip"></span></span>
                    <span class="chip">ë‹¤ìŒ ëª©í‘œ <span id="nextBadgeChip"></span></span>
                    <span class="chip">ì´ ë±ƒì§€ <span id="totalBadgeChip"></span></span>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="aqua-hero-visual">
                    <img src="characters/aqua.png" alt="Aqua ìºë¦­í„°" loading="lazy">
                    <div class="aqua-hero-bubble">
                        <b>â€œì§€ê¸ˆ ì•„ì£¼ ì¢‹ì€ íë¦„ì´ì—ìš”!â€</b>
                        <span>ì˜¤ëŠ˜ë„ ë¶€ë“œëŸ½ê²Œ ì ˆì•½ ìŠµê´€ì„ ì´ì–´ê°€ ë³¼ê¹Œìš”?</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <h2 class="aqua-section-title">Aquaê°€ ì¶•í•˜ë“œë ¤ìš”!</h2>
        <p class="aqua-section-subtitle">íšë“í•œ ë±ƒì§€ë¥¼ í•¨ê»˜ ê¸°ë»í•˜ê³ , ë‹¤ìŒ ëª©í‘œë„ í•¨ê»˜ ì •í•´ë´ìš”.</p>

        <!-- ì¶•í•˜ ì„¹ì…˜ - íšë“í•œ ë±ƒì§€ê°€ ìˆì„ ë•Œ -->
        <div id="celebrationSection" class="row mb-4" style="display: none;">
            <div class="col-lg-10 mx-auto">
                <div class="aqua-summary-card">
                    <div class="aqua-summary-header">
                        <div class="aqua-summary-icon">âœ¨</div>
                        <div>
                            <p class="aqua-summary-label">ì§€ê¸ˆê¹Œì§€ ëª¨ì€ ë±ƒì§€</p>
                            <h3 class="aqua-summary-title" id="earnedBadgeHeadline">0ê°œì˜ ì—¬ì •ì„ í•¨ê»˜í–ˆì–´ìš”</h3>
                        </div>
                    </div>
                    <p class="aqua-summary-sub" id="earnedBadgeSub">Aquaê°€ ì¡°ìš©íˆ ì‘ì› ì¤‘ì´ì—ìš”. ì•„ë˜ì—ì„œ ìƒì„¸ ë³´ìƒì„ í™•ì¸í•´ ë³´ì„¸ìš”.</p>
                    <div class="aqua-summary-pill-group" id="earnedBadgePills"></div>
                </div>
            </div>
        </div>

        <!-- ë‹¤ìŒ ë„ì „ ë±ƒì§€ ì„¹ì…˜ -->
        <div id="nextChallengeSection" class="mb-5" style="display: none;">
            <h3 class="aqua-next-section-title">ë‹¤ìŒ ì—¬ì •ì€ ì´ë ‡ê²Œ ì¤€ë¹„ë˜ì—ˆì–´ìš”</h3>
            <div class="row g-4 mb-3">
                <div class="col-md-6 mx-auto">
                    <div id="nextBadgeCard" class="aqua-next-badge-card text-center">
                        <span class="aqua-sparkle">âœ¨</span>
                        <div class="aqua-next-badge-header">
                            <div id="nextBadgeIcon" class="aqua-next-badge-icon">ğŸŒ¿</div>
                            <h4 id="nextBadgeName" class="aqua-next-badge-title">ë‹¤ìŒ ëª©í‘œ</h4>
                        </div>
                        <p id="nextBadgeDescription" class="aqua-next-badge-desc">Aquaê°€ ì¤€ë¹„í•œ ë§ì¶¤ ëª©í‘œë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”.</p>
                        <div id="nextBadgeConditions" class="aqua-next-badge-conditions">
                            <span class="condition-pill" id="nextBadgeCondition">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <a href="challenge.html" class="btn btn-lg aqua-cta-primary">ë‹¤ìŒ ëª©í‘œ ë„ì „í•˜ëŸ¬ ê°€ê¸° ğŸ’ª</a>
            </div>
        </div>

        <!-- íšë“í•œ ë±ƒì§€ ì„¹ì…˜ -->
        <div id="earnedBadgesSection" class="mb-5">
            <div class="aqua-category-header">
                <h3>ğŸ–ï¸ íšë“í•œ ë±ƒì§€</h3>
                <small id="earnedProgressLabel"></small>
            </div>
            <div id="earnedBadges" class="aqua-badge-grid">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>

        <!-- ëª¨ë“  ë±ƒì§€ ì„¹ì…˜ -->
        <div id="allBadgesSection">
            <h3 class="aqua-section-title">ğŸ“š ì „ì²´ ë±ƒì§€ ì—¬í–‰ ì§€ë„</h3>
            <p class="aqua-section-subtitle">ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì •ë¦¬ëœ ë±ƒì§€ë“¤ì˜ ì—¬ì •ì„ ì‚´í´ë³´ì„¸ìš”.</p>
            <div id="allBadges">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.API_BASE_URL = window.API_BASE_URL || '';
    </script>
    <script src="js/common.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!user.id) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        let allBadges = [];
        let userBadgeIds = [];

        // ë±ƒì§€ ë‚œì´ë„ ìˆœì„œ ì •ì˜ (íšë“í•˜ê¸° ì‰¬ìš´ ìˆœì„œ)
        const badgeOrder = [
            // ê¸°ë³¸
            'badge000', // ì‹œì‘ì˜ ë°œê±¸ìŒ (íšŒì›ê°€ì…)
            'badge001', // ì²« ì ˆì•½
            // ì ˆì•½ëŸ‰ ê¸°ë°˜
            'badge008', // ìƒˆì‹¹ ì ˆì•½ (10kWh)
            'badge006', // 50kWh í´ëŸ½
            'badge002', // ì—ë„ˆì§€ ë§ˆìŠ¤í„° (100kWh)
            'badge009', // 200kWh í´ëŸ½
            'badge010', // íƒ„ì†Œ ì œë¡œ íˆì–´ë¡œ (500kWh)
            'badge011', // ì ˆì•½ ë ˆì „ë“œ (1000kWh)
            // ë‹¬ì„±ë¥  ê¸°ë°˜
            'badge012', // ì™„ë²½ ë‹¬ì„± (100%)
            'badge013', // ìš°ìˆ˜ ë‹¬ì„± (120%)
            'badge007', // ëª©í‘œ ë‹¬ì„±ì™• (150%)
            'badge014', // ì´ˆì›” ë‹¬ì„± (200%)
            // ì§€ì†ì„± ê¸°ë°˜
            'badge015', // ì£¼ê°„ ì°¸ì—¬ì (1ì£¼)
            'badge004', // ì§€ì†ì˜ ë‹¬ì¸ (4ì£¼)
            'badge016', // ì¥ê¸° íŒŒì´í„° (8ì£¼)
            'badge017', // ì—°ì† ì±”í”¼ì–¸ (12ì£¼)
            // ë­í‚¹ ê¸°ë°˜
            'badge003', // ì£¼ê°„ ì±”í”¼ì–¸ (ì£¼ê°„ 1ìœ„)
            'badge005', // ì§€ì—­ íˆì–´ë¡œ (ì§€ì—­ë³„ 1ìœ„)
            'badge018', // ì „êµ­ ì±”í”¼ì–¸ (ì „êµ­ 1ìœ„)
            'badge019', // 2ìœ„ ë‹¬ì„±
            'badge020', // 3ìœ„ ë‹¬ì„±
            'badge021', // ìƒìœ„ 10%
            // ì°¸ì—¬ í™œë™ ê¸°ë°˜
            'badge022', // ë§ì¶¤í˜• ì„¤ë¬¸ ì™„ë£Œ
            'badge023', // ë¶„ì„ ë§ˆìŠ¤í„° (5íšŒ ì´ìƒ)
            'badge024', // ì§€ì›ì‚¬ì—… íƒí—˜ê°€ (10ê°œ ì´ìƒ)
            'badge025', // ì»¤ë®¤ë‹ˆí‹° ì°¸ì—¬ì (10íšŒ ì´ìƒ)
            // íŠ¹ë³„ ì´ë²¤íŠ¸ ê¸°ë°˜
            'badge026', // ì²«ë‚  ì™„ë²½
            'badge027', // ë³´ë„ˆìŠ¤ í€˜ìŠ¤íŠ¸ (ì›”ê°„ ì±Œë¦°ì§€ ì™„ë£Œ)
            'badge028', // ë ˆì¸ë³´ìš° (ëª¨ë“  ê¸°ë³¸ ë°°ì§€)
            'badge029'  // ë°ì¼ë¦¬ ì±Œë¦°ì € (7ì¼ ì—°ì†)
        ];

        // í˜ì´ì§€ ì´ˆê¸°í™”
        async function init() {
            await loadUserBadges();
            await loadAllBadges();
            displayBadges();
            findNextChallengeBadge();
        }

        // ì‚¬ìš©ì ë±ƒì§€ ë¡œë“œ
        async function loadUserBadges() {
            try {
                const response = await fetch(getApiUrl(`/api/challenge/user/${user.id}`));
                if (!response.ok) {
                    throw new Error(`ì‚¬ìš©ì ë±ƒì§€ API ì˜¤ë¥˜ (${response.status})`);
                }

                const data = await response.json();
                if (data.success && Array.isArray(data.badges)) {
                    userBadgeIds = data.badges;
                } else {
                    console.warn('ì‚¬ìš©ì ë±ƒì§€ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.', data);
                    userBadgeIds = [];
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ë±ƒì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
                showErrorMessage('ì‚¬ìš©ì ë±ƒì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì „ì²´ ë±ƒì§€ ëª©ë¡ ë¡œë“œ
        async function loadAllBadges() {
            try {
                const response = await fetch(getApiUrl('/api/challenge/badges'));
                if (!response.ok) {
                    throw new Error(`ì „ì²´ ë±ƒì§€ API ì˜¤ë¥˜ (${response.status})`);
                }

                const data = await response.json();
                if (data.success && Array.isArray(data.badges)) {
                    allBadges = data.badges;
                    allBadges.sort((a, b) => {
                        const indexA = badgeOrder.indexOf(a.id);
                        const indexB = badgeOrder.indexOf(b.id);
                        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
                    });
                } else {
                    console.warn('ì „ì²´ ë±ƒì§€ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.', data);
                    allBadges = [];
                }
            } catch (error) {
                console.error('ë±ƒì§€ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
                showErrorMessage('ì „ì²´ ë±ƒì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë±ƒì§€ í‘œì‹œ
        function displayBadges() {
            const totalBadgeChip = document.getElementById('totalBadgeChip');
            const earnedCountChip = document.getElementById('earnedCountChip');
            const earnedProgressLabel = document.getElementById('earnedProgressLabel');

            if (!allBadges || allBadges.length === 0) {
                document.getElementById('allBadges').innerHTML = '<p class="text-center text-muted">ë“±ë¡ëœ ë±ƒì§€ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”.</p>';
                if (totalBadgeChip) totalBadgeChip.textContent = '0ê°œ';
                if (earnedCountChip) earnedCountChip.textContent = `${userBadgeIds.length}ê°œ`;
                if (earnedProgressLabel) earnedProgressLabel.textContent = '';
                const celebration = document.getElementById('celebrationSection');
                if (celebration) celebration.style.display = 'none';
                return;
            }

            if (!userBadgeIds || !Array.isArray(userBadgeIds)) {
                userBadgeIds = [];
            }

            const earnedBadges = allBadges.filter(badge => userBadgeIds.includes(badge.id));

            // íšë“í•œ ë±ƒì§€ ì„¹ì…˜
            if (earnedBadges.length > 0) {
                const celebration = document.getElementById('celebrationSection');
                if (celebration) celebration.style.display = 'block';

                const summaryHeadline = document.getElementById('earnedBadgeHeadline');
                const summarySub = document.getElementById('earnedBadgeSub');
                const summaryPills = document.getElementById('earnedBadgePills');

                if (summaryHeadline) {
                    summaryHeadline.textContent = `${earnedBadges.length}ê°œì˜ ì—¬ì •ì„ í•¨ê»˜í–ˆì–´ìš”`;
                }

                if (summaryPills) {
                    const recentBadges = earnedBadges.filter(badge => badge).slice(-3).reverse();
                    summaryPills.innerHTML = recentBadges.map(badge => `<span class="aqua-summary-pill">${badge.icon} ${badge.name}</span>`).join('');
                }

                if (summarySub) {
                    const recentBadgeId = userBadgeIds[userBadgeIds.length - 1];
                    const recentBadge = allBadges.find(badge => badge.id === recentBadgeId) || earnedBadges[earnedBadges.length - 1];
                    if (recentBadge) {
                        summarySub.textContent = `${recentBadge.icon} ${recentBadge.name} ë°°ì§€ë¥¼ ê°€ì¥ ìµœê·¼ì— ëª¨ì•˜ì–´ìš”. Aquaì™€ í•¨ê»˜ ë‹¤ìŒ ëª©í‘œë¥¼ ì´ì–´ê°€ ë³¼ê¹Œìš”?`;
                    } else {
                        summarySub.textContent = 'Aquaê°€ ì¡°ìš©íˆ ì‘ì› ì¤‘ì´ì—ìš”. ì•„ë˜ì—ì„œ ìƒì„¸ ë³´ìƒì„ í™•ì¸í•´ ë³´ì„¸ìš”.';
                    }
                }

                document.getElementById('earnedBadges').innerHTML = earnedBadges.map(badge => `
                    <div class="aqua-badge-card earned text-center">
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-description">${badge.description}</div>
                        <div class="badge-condition">${badge.condition}</div>
                        <div class="mt-3 aqua-chip-earned">íšë“ ì™„ë£Œ ğŸ‰</div>
                    </div>
                `).join('');
            } else {
                document.getElementById('earnedBadgesSection').innerHTML = `
                    <div class="aqua-placeholder">
                        <div class="emoji">ğŸŒ±</div>
                        <h4>ì•„ì§ íšë“í•œ ë±ƒì§€ê°€ ì—†ì–´ìš”</h4>
                        <p>ì²« ì±Œë¦°ì§€ì— ë„ì „í•˜ë©´ Aquaê°€ íŠ¹ë³„í•œ ë±ƒì§€ë¥¼ ì¤€ë¹„í•´ë‘˜ê²Œìš”.</p>
                        <a href="challenge.html" class="btn btn-primary btn-lg">ì²« ì±Œë¦°ì§€ ì‹œì‘í•˜ê¸°</a>
                    </div>
                `;
                if (earnedCountChip) earnedCountChip.textContent = '0ê°œ';
                if (earnedProgressLabel) earnedProgressLabel.textContent = '';
                const celebration = document.getElementById('celebrationSection');
                if (celebration) celebration.style.display = 'none';
            }

            // ì¹´í…Œê³ ë¦¬ë³„ ë±ƒì§€ ë¶„ë¥˜
            const categories = {
                'ê¸°ë³¸': ['badge000', 'badge001'],
                'ì ˆì•½ëŸ‰ ê¸°ë°˜': ['badge008', 'badge006', 'badge002', 'badge009', 'badge010', 'badge011'],
                'ë‹¬ì„±ë¥  ê¸°ë°˜': ['badge012', 'badge013', 'badge007', 'badge014'],
                'ì§€ì†ì„± ê¸°ë°˜': ['badge015', 'badge004', 'badge016', 'badge017'],
                'ë­í‚¹ ê¸°ë°˜': ['badge003', 'badge005', 'badge018', 'badge019', 'badge020', 'badge021'],
                'ì°¸ì—¬ í™œë™ ê¸°ë°˜': ['badge022', 'badge023', 'badge024', 'badge025'],
                'íŠ¹ë³„ ì´ë²¤íŠ¸ ê¸°ë°˜': ['badge026', 'badge027', 'badge028', 'badge029']
            };

            const categoryNames = {
                'ê¸°ë³¸': 'ğŸŒŸ ê¸°ë³¸',
                'ì ˆì•½ëŸ‰ ê¸°ë°˜': 'ğŸ’š ì ˆì•½ëŸ‰ ê¸°ë°˜',
                'ë‹¬ì„±ë¥  ê¸°ë°˜': 'ğŸ¯ ë‹¬ì„±ë¥  ê¸°ë°˜',
                'ì§€ì†ì„± ê¸°ë°˜': 'ğŸ”¥ ì§€ì†ì„± ê¸°ë°˜',
                'ë­í‚¹ ê¸°ë°˜': 'ğŸ† ë­í‚¹ ê¸°ë°˜',
                'ì°¸ì—¬ í™œë™ ê¸°ë°˜': 'ğŸ“Š ì°¸ì—¬ í™œë™ ê¸°ë°˜',
                'íŠ¹ë³„ ì´ë²¤íŠ¸ ê¸°ë°˜': 'âœ¨ íŠ¹ë³„ ì´ë²¤íŠ¸ ê¸°ë°˜'
            };

            // ì¹´í…Œê³ ë¦¬ë³„ë¡œ HTML ìƒì„±
            let allBadgesHtml = '';
            Object.keys(categories).forEach(categoryName => {
                const categoryBadgeIds = categories[categoryName];
                const categoryBadges = allBadges.filter(badge => categoryBadgeIds.includes(badge.id));
                
                if (categoryBadges.length > 0) {
                    const categoryDisplayName = categoryNames[categoryName] || categoryName;
                    allBadgesHtml += `
                        <div class="mb-5">
                            <div class="aqua-category-header">
                                <h3>${categoryDisplayName}</h3>
                                <small>
                                    (${categoryBadges.filter(b => userBadgeIds.includes(b.id)).length}/${categoryBadges.length} íšë“)
                                </small>
                            </div>
                            <div class="aqua-badge-grid">
                                ${categoryBadges.map(badge => {
                                    const hasBadge = userBadgeIds.includes(badge.id);
                                    return `
                                        <div class="aqua-badge-card ${hasBadge ? 'earned' : 'locked'} text-center">
                                            <div class="badge-icon">${badge.icon}</div>
                                            <div class="badge-name">${badge.name}</div>
                                            <div class="badge-description">${badge.description}</div>
                                            <div class="badge-condition">${badge.condition}</div>
                                            ${hasBadge ? '<div class="mt-3 aqua-chip-earned">íšë“ ì™„ë£Œ ğŸ‰</div>' : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });

                document.getElementById('allBadges').innerHTML = allBadgesHtml || '<p class="text-center text-muted">ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                if (totalBadgeChip) totalBadgeChip.textContent = `${allBadges.length}ê°œ`;
        }

        // ë‹¤ìŒ ë„ì „ ë±ƒì§€ ì°¾ê¸°
        function findNextChallengeBadge() {
            if (!userBadgeIds || !Array.isArray(userBadgeIds)) {
                userBadgeIds = [];
            }
            
            if (!allBadges || allBadges.length === 0) {
                return;
            }

            // ë±ƒì§€ ìˆœì„œëŒ€ë¡œ í™•ì¸í•˜ì—¬ íšë“í•˜ì§€ ì•Šì€ ì²« ë²ˆì§¸ ë±ƒì§€ ì°¾ê¸°
            for (const badgeId of badgeOrder) {
                if (!userBadgeIds.includes(badgeId)) {
                    const nextBadge = allBadges.find(b => b.id === badgeId);
                    if (nextBadge) {
                        displayNextChallengeBadge(nextBadge);
                        return;
                    }
                }
            }

            // ëª¨ë“  ë±ƒì§€ë¥¼ íšë“í•œ ê²½ìš°
            if (userBadgeIds.length === allBadges.length) {
                document.getElementById('nextChallengeSection').innerHTML = `
                    <div class="text-center py-5">
                        <div style="font-size: 5rem; margin-bottom: 20px;">ğŸ†</div>
                        <h3 class="fw-bold mb-3">ì¶•í•˜í•©ë‹ˆë‹¤! ğŸŠ</h3>
                        <p class="lead">ëª¨ë“  ë±ƒì§€ë¥¼ íšë“í•˜ì…¨ë„¤ìš”! ì •ë§ ëŒ€ë‹¨í•´ìš”!</p>
                        <p class="text-muted">ê³„ì†í•´ì„œ ì—ë„ˆì§€ ì ˆì•½ì— ë„ì „í•´ë³´ì„¸ìš”! ğŸŒ±</p>
                    </div>
                `;
                document.getElementById('nextChallengeSection').style.display = 'block';
            }
        }

        // ë‹¤ìŒ ë„ì „ ë±ƒì§€ í‘œì‹œ
        function displayNextChallengeBadge(badge) {
            document.getElementById('nextChallengeSection').style.display = 'block';
            document.getElementById('nextBadgeIcon').textContent = badge.icon;
            document.getElementById('nextBadgeName').textContent = badge.name;
            document.getElementById('nextBadgeDescription').textContent = badge.description;
            document.getElementById('nextBadgeChip').textContent = badge.name;

            const conditions = document.getElementById('nextBadgeConditions');
            if (conditions) {
                conditions.innerHTML = `<span class="condition-pill">${badge.condition}</span>`;
            }
        }

        function showErrorMessage(message) {
            const container = document.getElementById('allBadges');
            if (container) {
                container.innerHTML = `<p class="text-center text-danger">${message}</p>`;
            }
        }

        function startPage() {
            init().catch(error => {
                console.error('ë±ƒì§€ í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                document.getElementById('allBadges').innerHTML = '<p class="text-center text-danger">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startPage);
        } else {
            startPage();
        }
    </script>
</body>
</html>

