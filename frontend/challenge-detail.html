<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±Œë¦°ì§€ ìƒì„¸ - ì—ë„ˆì§€ ì ˆì•½ í”Œë«í¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="index.html">âš¡ ì—ë„ˆì§€ì ˆì•½</a>
            <a href="challenge.html" class="text-muted">â† ì±Œë¦°ì§€ë¡œ</a>
        </div>
    </nav>

    <div class="container py-5">
        <div id="challengeDetail">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!user.id) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        let chartInstance = null;
        let weeklyChartInstance = null;
        let userEnergyTier = 2; // ê¸°ë³¸ê°’ 2êµ¬ê°„
        let weeklyProgressData = null;

        // kWh â†’ ê¸ˆì•¡ í™˜ì‚° í•¨ìˆ˜
        function convertKwhToMoney(kwh, tier = null) {
            const rates = {
                1: 93.3,    // 1êµ¬ê°„ (200kWh ì´í•˜)
                2: 187.9,   // 2êµ¬ê°„ (201-400kWh)
                3: 280.6,   // 3êµ¬ê°„ (401kWh ì´ìƒ)
                4: 416.1    // 4êµ¬ê°„ (íŠ¹ê³ ì••)
            };
            
            const rate = tier ? rates[tier] || 187.9 : 187.9;
            return Math.round(kwh * rate);
        }

        // ê¸ˆì•¡ í¬ë§·íŒ…
        function formatMoney(amount) {
            return amount.toLocaleString() + 'ì›';
        }

        async function loadChallengeDetail() {
            try {
                const response = await fetch(`/api/challenge/user/${user.id}`);
                const data = await response.json();

                if (data.success && data.challenge) {
                    userEnergyTier = data.energyTier || 2;
                    weeklyProgressData = data.weeklyProgress;
                    displayChallengeDetail(data.challenge, data.energyTier || 2, data.weeklyProgress, data.prediction);
                } else {
                    document.getElementById('challengeDetail').innerHTML = `
                        <div class="alert alert-info">
                            <p class="mb-0">ì§„í–‰ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. <a href="challenge.html">ì±Œë¦°ì§€ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</a></p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ì±Œë¦°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        function displayChallengeDetail(challenge, tier = 2, weeklyProgress = null, prediction = null) {
            const achievementRate = challenge.achievementRate || 0;
            const remaining = Math.max(0, (challenge.targetKwh || 0) - (challenge.savedKwh || 0));
            const daysLeft = Math.ceil((new Date(challenge.endDate) - new Date()) / (1000 * 60 * 60 * 24));
            const savedKwh = challenge.savedKwh || 0;
            const targetKwh = challenge.targetKwh || 0;

            // ê¸ˆì•¡ í™˜ì‚°
            const savedMoney = convertKwhToMoney(savedKwh, tier);
            const targetMoney = convertKwhToMoney(targetKwh, tier);
            const remainingMoney = convertKwhToMoney(remaining, tier);

            document.getElementById('challengeDetail').innerHTML = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="fw-bold mb-2">${challenge.type === 'weekly' ? 'ì£¼ê°„' : 'ì›”ê°„'} ì ˆì•½ ì±Œë¦°ì§€</h2>
                        <p class="text-muted">${challenge.startDate} ~ ${challenge.endDate}</p>
                        <div class="alert alert-info mb-2">
                            <small><strong>í˜„ì¬ ${tier}êµ¬ê°„ ê¸°ì¤€</strong>ìœ¼ë¡œ ê¸ˆì•¡ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</small>
                        </div>
                        ${prediction ? `
                        <div class="alert alert-light border mb-0">
                            <small>
                                <strong>ğŸ“Š ì˜ˆì¸¡ ì •ë³´</strong><br>
                                ì˜ˆìƒ ì‚¬ìš©ëŸ‰: ${prediction.predictedUsage}kWh/ì›” | 
                                ì‹ ë¢°ë„: ${prediction.confidence} | 
                                ê¸°ì¤€: ${prediction.dataSource}<br>
                                <span class="text-muted">${prediction.disclaimer}</span>
                            </small>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- ì§„í–‰ë¥  -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <h3 class="fw-bold mb-2">ëª©í‘œ ë‹¬ì„±ë¥ </h3>
                            <div class="progress-ring mb-3 position-relative" style="width: 200px; height: 200px; margin: 0 auto;">
                                <canvas id="progressChart" width="200" height="200"></canvas>
                                <div class="position-absolute top-50 start-50 translate-middle text-center">
                                    <h2 class="fw-bold mb-0">${achievementRate}%</h2>
                                    <small class="text-muted">ë‹¬ì„±</small>
                                </div>
                            </div>
                        </div>

                        <div class="row g-4">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="fw-bold text-success">${savedKwh}</h4>
                                    <p class="text-muted mb-1">ì ˆì•½ëŸ‰ (kWh)</p>
                                    <p class="text-success fw-bold mb-0">ì›” ${formatMoney(savedMoney)}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="fw-bold text-primary">${targetKwh}</h4>
                                    <p class="text-muted mb-1">ëª©í‘œëŸ‰ (kWh)</p>
                                    <p class="text-primary fw-bold mb-0">ì›” ${formatMoney(targetMoney)}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="fw-bold text-warning">${remaining}</h4>
                                    <p class="text-muted mb-1">ë‚¨ì€ëŸ‰ (kWh)</p>
                                    <p class="text-warning fw-bold mb-0">ì•½ ${formatMoney(remainingMoney)}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="fw-bold text-info">${daysLeft}</h4>
                                    <p class="text-muted mb-0">ë‚¨ì€ ì¼ìˆ˜</p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <div class="progress" style="height: 30px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                     role="progressbar" 
                                     style="width: ${Math.min(achievementRate, 100)}%">
                                    ${achievementRate}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì£¼ê°„ë³„ ë‹¬ì„±ë¥  -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold mb-0">ì£¼ê°„ë³„ ëª©í‘œ ë‹¬ì„±ë¥ </h5>
                            <small class="text-muted">í•œì „ í†µê³„ ê¸°ë°˜ ì˜ˆì¸¡</small>
                        </div>
                        <canvas id="weeklyChart" height="80"></canvas>
                        <div class="mt-3">
                            <div class="row g-2" id="weeklyProgressCards">
                                <!-- ì£¼ê°„ë³„ ì¹´ë“œê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì ˆì•½ëŸ‰ ê·¸ë˜í”„ -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4">ì¼ë³„ ì ˆì•½ëŸ‰ ì¶”ì´</h5>
                        <canvas id="savingsChart" height="100"></canvas>
                    </div>
                </div>

                <!-- ì ˆì•½ëŸ‰ ì…ë ¥ -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4">ì ˆì•½ëŸ‰ ì—…ë°ì´íŠ¸</h5>
                        <form id="updateForm">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label">ì ˆì•½í•œ ì „ê¸°ëŸ‰ (kWh)</label>
                                    <input type="number" class="form-control" id="savedKwh" 
                                           placeholder="ì˜ˆ: 15" step="0.1" required oninput="updateSavedMoneyPreview()">
                                    <small class="text-muted mt-2 d-block" id="savedMoneyPreview">
                                        ì˜ˆìƒ ì ˆì•½ ê¸ˆì•¡: <span id="savedMoneyAmount">-</span> (${tier}êµ¬ê°„ ê¸°ì¤€)
                                    </small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100 btn-lg">
                                        ì—…ë°ì´íŠ¸
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // ì›í˜• ì°¨íŠ¸
            const progressCtx = document.getElementById('progressChart');
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(progressCtx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [achievementRate, 100 - achievementRate],
                        backgroundColor: ['#198754', '#e9ecef'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // ì ˆì•½ëŸ‰ ì¶”ì´ ì°¨íŠ¸ (ë”ë¯¸ ë°ì´í„°)
            const savingsCtx = document.getElementById('savingsChart');
            const days = Array.from({ length: daysLeft > 0 ? 30 - daysLeft : 30 }, (_, i) => `Day ${i + 1}`);
            const savingsData = Array.from({ length: days.length }, () => 
                Math.random() * 5 + (challenge.savedKwh || 0) / days.length
            );

            new Chart(savingsCtx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'ì¼ë³„ ì ˆì•½ëŸ‰ (kWh)',
                        data: savingsData,
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // ì£¼ê°„ë³„ ë‹¬ì„±ë¥  ì°¨íŠ¸ ë° ì¹´ë“œ
            if (weeklyProgress && weeklyProgress.length > 0) {
                displayWeeklyProgress(weeklyProgress, tier);
            }

            // ì ˆì•½ëŸ‰ ì…ë ¥ ì‹œ ê¸ˆì•¡ ë¯¸ë¦¬ë³´ê¸°
            window.updateSavedMoneyPreview = function() {
                const inputKwh = parseFloat(document.getElementById('savedKwh')?.value || 0);
                if (inputKwh > 0) {
                    const money = convertKwhToMoney(inputKwh, tier);
                    const totalSaved = inputKwh + savedKwh;
                    const totalMoney = convertKwhToMoney(totalSaved, tier);
                    
                    document.getElementById('savedMoneyAmount').textContent = formatMoney(money);
                    document.getElementById('savedMoneyPreview').style.display = 'block';
                    document.getElementById('savedMoneyPreview').innerHTML = `
                        ì˜ˆìƒ ì ˆì•½ ê¸ˆì•¡: <strong>${formatMoney(money)}</strong> (${tier}êµ¬ê°„ ê¸°ì¤€)<br>
                        <small class="text-muted">ì´ ì ˆì•½: ${totalSaved.toFixed(1)}kWh â†’ ${formatMoney(totalMoney)}</small>
                    `;
                } else {
                    document.getElementById('savedMoneyPreview').style.display = 'none';
                }
            };

            // ì—…ë°ì´íŠ¸ í¼
            document.getElementById('updateForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const newKwh = parseFloat(document.getElementById('savedKwh').value);
                const totalKwh = newKwh + savedKwh;
                const totalMoney = convertKwhToMoney(totalKwh, tier);

                if (!confirm(`${newKwh.toFixed(1)}kWhë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì ˆì•½: ${totalKwh.toFixed(1)}kWh (ì›” ${formatMoney(totalMoney)})`)) {
                    return;
                }

                try {
                    const response = await fetch('/api/challenge/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            savedKwh: totalKwh
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert(`ì ˆì•½ëŸ‰ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ ì ˆì•½: ${totalKwh.toFixed(1)}kWh (ì›” ${formatMoney(totalMoney)})`);
                        location.reload();
                    } else {
                        alert(data.message || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        // ì£¼ê°„ë³„ ì§„í–‰ë¥  í‘œì‹œ
        function displayWeeklyProgress(weeklyData, tier) {
            // ì£¼ê°„ë³„ ë§‰ëŒ€ ê·¸ë˜í”„
            const weeklyCtx = document.getElementById('weeklyChart');
            
            if (weeklyChartInstance) {
                weeklyChartInstance.destroy();
            }

            const labels = weeklyData.map(w => w.weekLabel);
            const achievementRates = weeklyData.map(w => w.achievementRate);
            const savedData = weeklyData.map(w => w.saved);
            const targetData = weeklyData.map(w => w.target);

            weeklyChartInstance = new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ëª©í‘œ (kWh)',
                            data: targetData,
                            backgroundColor: 'rgba(13, 110, 253, 0.3)',
                            borderColor: '#0d6efd',
                            borderWidth: 1
                        },
                        {
                            label: 'ì ˆì•½ëŸ‰ (kWh)',
                            data: savedData,
                            backgroundColor: weeklyData.map(w => {
                                if (w.isCurrent) return 'rgba(255, 193, 7, 0.7)';
                                if (w.isCompleted) return 'rgba(25, 135, 84, 0.7)';
                                return 'rgba(233, 236, 239, 0.7)';
                            }),
                            borderColor: weeklyData.map(w => {
                                if (w.isCurrent) return '#ffc107';
                                if (w.isCompleted) return '#198754';
                                return '#e9ecef';
                            }),
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const week = weeklyData[index];
                                    return `ë‹¬ì„±ë¥ : ${week.achievementRate}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ì ˆì•½ëŸ‰ (kWh)'
                            }
                        }
                    }
                }
            });

            // ì£¼ê°„ë³„ ì¹´ë“œ ìƒì„±
            const cardsContainer = document.getElementById('weeklyProgressCards');
            cardsContainer.innerHTML = weeklyData.map(week => {
                const statusClass = week.isCurrent ? 'border-warning border-3' : 
                                  week.isCompleted ? 'border-success' : 'border-secondary';
                const statusBadge = week.isCurrent ? '<span class="badge bg-warning text-dark">ì§„í–‰ì¤‘</span>' :
                                   week.isCompleted ? '<span class="badge bg-success">ì™„ë£Œ</span>' :
                                   '<span class="badge bg-secondary">ì˜ˆì •</span>';
                
                const weekMoney = convertKwhToMoney(week.saved, tier);
                const targetMoney = convertKwhToMoney(week.target, tier);

                return `
                    <div class="col-md-6 col-lg-3">
                        <div class="card ${statusClass} h-100">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="fw-bold mb-0">${week.weekLabel}</h6>
                                    ${statusBadge}
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">${week.weekStart} ~ ${week.weekEnd}</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar ${week.isCompleted ? 'bg-success' : week.isCurrent ? 'bg-warning' : 'bg-secondary'}" 
                                         role="progressbar" 
                                         style="width: ${Math.min(week.achievementRate, 100)}%">
                                        ${week.achievementRate}%
                                    </div>
                                </div>
                                <div class="small">
                                    <div class="d-flex justify-content-between">
                                        <span>ì ˆì•½:</span>
                                        <strong class="text-success">${week.saved.toFixed(1)}kWh</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>ëª©í‘œ:</span>
                                        <span>${week.target.toFixed(1)}kWh</span>
                                    </div>
                                    <div class="mt-1 text-muted" style="font-size: 0.7rem;">
                                        ì•½ ${formatMoney(weekMoney)} ì ˆì•½
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        loadChallengeDetail();
    </script>
</body>
</html>

