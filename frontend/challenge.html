<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë„ˆì§€ ì ˆì•½ ì±Œë¦°ì§€ - ì—ë„ˆì§€ ì ˆì•½ í”Œë«í¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/themes.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .badge-card {
            background: linear-gradient(135deg, #d9c7ff 0%, #bba0ff 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        .progress-ring {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }
        .challenge-card {
            transition: transform 0.2s;
        }
        .challenge-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body class="theme-lilac">
    <nav class="navbar navbar-expand-lg navbar-light navbar-theme shadow-sm py-3">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">ğŸƒ ecopass</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">ë¡œë¹„</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="programs.html">ì§€ì›ì‚¬ì—…</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="challenge.html">ì±Œë¦°ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ranking.html">ë­í‚¹</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="challenge-list.html">ê°™ì´í•´ìš”</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <section class="themed-hero mt-4">
            <div class="floating-bubbles">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="themed-hero-inner">
                <div>
                    <div class="themed-badge">
                        <span>ğŸ”¥ Flamyì™€ í•¨ê»˜</span>
                        <span>ì—´ì • ê°€ë“ ì±Œë¦°ì§€</span>
                    </div>
                    <h1 class="display-5 fw-bold mb-3">ì—ë„ˆì§€ ì ˆì•½ì„ ê²Œì„ì²˜ëŸ¼, ì¦ê²ê²Œ!</h1>
                    <p class="mb-4">ì—´ì • ë¦¬ë” Flamyê°€ ì±Œë¦°ì§€ ì—¬í–‰ì„ ì•ˆë‚´í•©ë‹ˆë‹¤. ê·€ì—¬ìš´ ìºë¦­í„°ì™€ í•¨ê»˜ ëª©í‘œë¥¼ ì„¸ìš°ê³ , í¬ì¸íŠ¸ì™€ ë°°ì§€ë¥¼ ìˆ˜ì§‘í•´ë³´ì„¸ìš”.</p>
                    <div class="d-flex flex-wrap gap-3">
                        <a href="survey.html" class="btn btn-theme-secondary">ë§ì¶¤í˜• ì ˆì•½íŒ ë°›ê¸°</a>
                    </div>
                </div>
                <div class="text-center">
                    <div class="theme-character-wrapper">
                        <img src="characters/flamy.png" alt="Flamy ìºë¦­í„°" class="theme-character">
                        <div class="hero-rank-bubble">
                            <div class="hero-rank-label">ë‚´ ì±Œë¦°ì§€ ìˆœìœ„</div>
                            <div class="hero-rank-message" id="heroRankMessage">Flamyê°€ ìˆœìœ„ë¥¼ í™•ì¸í•˜ê³  ìˆì–´ìš”...</div>
                            <a href="ranking.html" class="hero-rank-link" id="heroRankLink">ì „ì²´ ë­í‚¹ ë³´ê¸° â†’</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div class="container py-5">
        <!-- ë‚´ ì±Œë¦°ì§€ í˜„í™© -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="soft-section text-center">
                    <h2 class="fw-bold mb-3">ğŸ† ì—ë„ˆì§€ ì ˆì•½ ì±Œë¦°ì§€</h2>
                    <p class="text-muted mb-0">ëª©í‘œë¥¼ ì„¸ìš°ê³ , ì ˆì•½ì„ ì‹¤ì²œí•˜ê³ , ê·€ì—¬ìš´ ìºë¦­í„°ì™€ í•¨ê»˜ ë³´ìƒì„ ë°›ì•„ë³´ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <div id="challengeStatus" class="row g-4 mb-5">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
        </div>

        <!-- ìƒˆ ì±Œë¦°ì§€ ì‹œì‘ -->
        <div class="themed-card mb-5" id="newChallengeCard">
            <div class="card-body p-5">
                <h4 class="fw-bold mb-4">ìƒˆ ì±Œë¦°ì§€ ì‹œì‘í•˜ê¸°</h4>
                <form id="challengeForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">ëª©í‘œ ìœ í˜•</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="type" id="weekly" value="weekly" checked>
                                <label class="btn btn-theme-secondary" for="weekly">ì£¼ê°„ ëª©í‘œ (7ì¼)</label>
                                
                                <input type="radio" class="btn-check" name="type" id="monthly" value="monthly">
                                <label class="btn btn-theme-secondary" for="monthly">ì›”ê°„ ëª©í‘œ (30ì¼)</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ì ˆì•½ ëª©í‘œ</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="targetKwh" placeholder="ì˜ˆ: 50" required oninput="updateTargetMoney()">
                                <span class="input-group-text">kWh</span>
                            </div>
                            <small class="text-muted mt-2 d-block" id="targetMoneyPreview">
                                ëª©í‘œ ê¸ˆì•¡: <span id="targetMoneyAmount">-</span>
                            </small>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="submit" class="btn btn-theme-primary btn-lg px-5">ì±Œë¦°ì§€ ì‹œì‘í•˜ê¸° ğŸš€</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ë‚´ ë°°ì§€ -->
        <div class="themed-card mb-5">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0">ğŸ… íšë“í•œ ë°°ì§€</h5>
                    <a href="badges.html" class="btn btn-theme-secondary px-4 py-2" style="font-size: 1rem; font-weight: 600;">ë±ƒì§€ êµ¬ê²½í•˜ê¸° âœ¨</a>
                </div>
                <div id="myBadges" class="row g-3">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                </div>
            </div>
        </div>

        <!-- í¬ì¸íŠ¸ & í†µê³„ -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="themed-card text-center h-100">
                    <div class="card-body p-4">
                        <h3 class="mb-2">ğŸ’ í¬ì¸íŠ¸</h3>
                        <h2 class="fw-bold" id="userPoints">0</h2>
                        <small class="text-muted">1kWhë‹¹ 10í¬ì¸íŠ¸</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="themed-card text-center h-100">
                    <div class="card-body p-4">
                        <h3 class="mb-2">âš¡ ì´ ì ˆì•½ëŸ‰</h3>
                        <h2 class="fw-bold" id="totalSaved">0</h2>
                        <small class="text-muted">kWh</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="themed-card text-center h-100">
                    <div class="card-body p-4">
                        <h3 class="mb-2">ğŸ¯ ì°¸ì—¬ì ìˆ˜</h3>
                        <h2 class="fw-bold" id="totalParticipants">-</h2>
                        <small class="text-muted">ëª…</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì§„í–‰ì¤‘ì¸ ì±Œë¦°ì§€ ëª©ë¡ -->
        <div class="themed-card">
            <div class="card-body p-4">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                    <h5 class="fw-bold mb-0">ğŸ”¥ ì§„í–‰ì¤‘ì¸ ì±Œë¦°ì§€</h5>
                    <a href="challenge-list.html" class="btn btn-theme-secondary mt-3 mt-md-0">ë” ë§ì€ ì±Œë¦°ì§€ ë³´ê¸°</a>
                </div>
                <div id="activeChallenges">
                    <p id="activeChallengesEmpty" class="text-muted text-center py-4 mb-0">ì°¸ì—¬ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ì–´ìš”. ê°™ì´ í•´ìš”ì—ì„œ ìƒˆë¡œìš´ í™œë™ì„ ì°¾ì•„ë³´ì„¸ìš”!</p>
                    <div id="activeChallengesList" class="row g-4 d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.API_BASE_URL = window.API_BASE_URL || '';
    </script>
    <script src="js/common.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!user.id) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        let userChallenge = null;
        let allBadges = [];
        let userEnergyTier = 2; // ê¸°ë³¸ê°’ 2êµ¬ê°„

        function calculateDDay(endDate) {
            if (!endDate) return 'ì§„í–‰ì¤‘';
            const end = new Date(endDate);
            const today = new Date();
            end.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            const diff = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
            if (Number.isNaN(diff)) return 'ì§„í–‰ì¤‘';
            if (diff > 0) return `D-${diff}`;
            if (diff === 0) return 'D-DAY';
            return 'ì¢…ë£Œ';
        }

        function renderActiveChallengeCard(challenge, tier = 2) {
            const activeList = document.getElementById('activeChallengesList');
            const emptyMessage = document.getElementById('activeChallengesEmpty');
            if (!activeList) {
                return;
            }

            const targetKwh = challenge.targetKwh || 0;
            const savedKwh = challenge.savedKwh || 0;
            const achievementRate = challenge.achievementRate || Math.round(targetKwh ? (savedKwh / targetKwh) * 100 : 0);
            const typeLabel = challenge.type === 'weekly' ? 'ì£¼ê°„ ì±Œë¦°ì§€' : 'ì›”ê°„ ì±Œë¦°ì§€';
            const expectedPoints = challenge.expectedPoints || Math.round(targetKwh * 10);
            const dDayLabel = calculateDDay(challenge.endDate);
            const targetMoney = convertKwhToMoney(targetKwh, tier);
            const savedMoney = convertKwhToMoney(savedKwh, tier);

            if (emptyMessage) {
                emptyMessage.classList.add('d-none');
            }

            activeList.classList.remove('d-none');
            activeList.innerHTML = `
                <div class="col-12 col-lg-6">
                    <div class="themed-card h-100 p-0 overflow-hidden">
                        <div class="d-flex align-items-center justify-content-center" style="height: 140px; background: linear-gradient(135deg, var(--theme-hero-start), var(--theme-hero-end)); font-size: 3rem;">
                            âš¡
                        </div>
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="tag-pill">${typeLabel}</span>
                                <span class="fw-bold" style="color: var(--theme-strong);">${dDayLabel}</span>
                            </div>
                            <h6 class="fw-bold mb-1">${challenge.title || 'ìš°ë¦¬ì§‘ ì ˆì•½ ì±Œë¦°ì§€'}</h6>
                            <p class="text-muted small mb-3">${challenge.startDate || 'ì‹œì‘ì¼ ë¯¸ì •'} ~ ${challenge.endDate || 'ì§„í–‰ì¤‘'}</p>
                            <div class="progress mb-3" style="height: 12px; background: rgba(255, 255, 255, 0.6);">
                                <div class="progress-bar" style="background: var(--theme-strong); width: ${Math.min(achievementRate, 100)}%;" aria-valuenow="${achievementRate}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <div class="themed-border p-3 text-center h-100">
                                        <div class="text-muted small">ì ˆì•½ëŸ‰</div>
                                        <div class="fw-bold fs-5" style="color: var(--theme-strong);">${savedKwh}kWh</div>
                                        <div class="small" style="color: var(--theme-strong);">ì›” ${formatMoney(savedMoney)}</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="themed-border p-3 text-center h-100">
                                        <div class="text-muted small">ëª©í‘œ</div>
                                        <div class="fw-bold fs-5">${targetKwh}kWh</div>
                                        <div class="small text-muted">ì›” ${formatMoney(targetMoney)}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center text-muted small">
                                <span>ğŸ… ì˜ˆìƒ í¬ì¸íŠ¸</span>
                                <span class="fw-bold" style="color: var(--theme-strong);">${expectedPoints.toLocaleString()} P</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // kWh â†’ ê¸ˆì•¡ í™˜ì‚° í•¨ìˆ˜
        function convertKwhToMoney(kwh, tier = null) {
            const rates = {
                1: 93.3,    // 1êµ¬ê°„ (200kWh ì´í•˜)
                2: 187.9,   // 2êµ¬ê°„ (201-400kWh)
                3: 280.6,   // 3êµ¬ê°„ (401kWh ì´ìƒ)
                4: 416.1    // 4êµ¬ê°„ (íŠ¹ê³ ì••)
            };
            
            const rate = tier ? rates[tier] || 187.9 : 187.9; // tierê°€ ì—†ìœ¼ë©´ í‰ê·  ë‹¨ê°€ ì‚¬ìš©
            return Math.round(kwh * rate);
        }

        // ê¸ˆì•¡ í¬ë§·íŒ…
        function formatMoney(amount) {
            return amount.toLocaleString() + 'ì›';
        }

        // kWhì™€ ê¸ˆì•¡ì„ í•¨ê»˜ í‘œì‹œí•˜ëŠ” í…ìŠ¤íŠ¸ ìƒì„±
        function formatKwhWithMoney(kwh, tier = null) {
            const money = convertKwhToMoney(kwh, tier);
            return `${kwh}kWh (ì›” ${formatMoney(money)})`;
        }

        // í˜ì´ì§€ ë¡œë“œ
        async function init() {
            await loadChallenge();
            await loadBadges();
            await loadStats();
        }

        // ì±Œë¦°ì§€ ì¡°íšŒ
        async function loadChallenge() {
            try {
                const response = await fetch(getApiUrl(`/api/challenge/user/${user.id}`));
                const data = await response.json();

                if (data.success && data.challenge) {
                    userChallenge = data.challenge;
                    userEnergyTier = data.energyTier || 2;
                    displayChallengeStatus(data.challenge, data.totalSaved, data.points, data.badges, data.energyTier, data.weeklyProgress, data.prediction);
                } else {
                    showNoChallengeState();
                }
            } catch (error) {
                console.error('ì±Œë¦°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
                showNoChallengeState();
            }
        }

        // ì±Œë¦°ì§€ ìƒíƒœ í‘œì‹œ
        function displayChallengeStatus(challenge, totalSaved, points, badges, tier = 2, weeklyProgress = null, prediction = null) {
            if (!challenge) {
                return;
            }

            const achievementRate = challenge.achievementRate || 0;
            const remaining = Math.max(0, (challenge.targetKwh || 0) - (challenge.savedKwh || 0));
            const savedKwh = challenge.savedKwh || 0;
            const targetKwh = challenge.targetKwh || 0;
            
            // ê¸ˆì•¡ í™˜ì‚°
            const savedMoney = convertKwhToMoney(savedKwh, tier);
            const targetMoney = convertKwhToMoney(targetKwh, tier);
            const remainingMoney = convertKwhToMoney(remaining, tier);

            document.getElementById('challengeStatus').innerHTML = `
                <div class="col-12">
                    <div class="themed-card h-100">
                        <h5 class="fw-bold mb-4">ë‚´ ì±Œë¦°ì§€ í˜„í™©</h5>
                        
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span>ëª©í‘œ ë‹¬ì„±ë¥ </span>
                                <span class="fw-bold" style="color: var(--theme-strong);">${achievementRate}%</span>
                            </div>
                            <div class="progress" style="height: 28px; background: rgba(255, 255, 255, 0.6);">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="background: var(--theme-strong); width: ${Math.min(achievementRate, 100)}%" 
                                     aria-valuenow="${achievementRate}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    ${achievementRate}%
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <div class="themed-border p-3 text-center h-100">
                                    <h6 class="text-muted mb-1">ì ˆì•½ëŸ‰</h6>
                                    <h4 class="fw-bold" style="color: var(--theme-strong);">${savedKwh}</h4>
                                    <small class="text-muted d-block">kWh</small>
                                    <small class="fw-bold" style="color: var(--theme-strong);">ì›” ${formatMoney(savedMoney)}</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="themed-border p-3 text-center h-100">
                                    <h6 class="text-muted mb-1">ëª©í‘œê¹Œì§€</h6>
                                    <h4 class="fw-bold">${remaining}</h4>
                                    <small class="text-muted d-block">kWh ë‚¨ìŒ</small>
                                    <small class="fw-bold text-muted">ì•½ ${formatMoney(remainingMoney)}</small>
                                </div>
                            </div>
                        </div>

                        ${weeklyProgress && weeklyProgress.length > 0 ? `
                        <div class="mb-3">
                            <h6 class="fw-bold mb-2">ğŸ“… ì£¼ê°„ë³„ ì§„í–‰ í˜„í™©</h6>
                            <div class="row g-2">
                                ${weeklyProgress.slice(0, 4).map(week => `
                                    <div class="col-6 col-md-3">
                                        <div class="themed-border p-2 text-center" style="font-size: 0.85rem; border-color: ${week.isCurrent ? 'var(--theme-strong)' : 'var(--theme-border)'};">
                                            <div class="fw-bold mb-1">${week.weekLabel}</div>
                                            <div class="progress mb-1" style="height: 12px;">
                                                <div class="progress-bar" 
                                                     style="background: ${week.isCompleted ? 'var(--theme-strong)' : week.isCurrent ? 'var(--theme-accent)' : 'rgba(0,0,0,0.2)'}; width: ${Math.min(week.achievementRate, 100)}%">
                                                    ${week.achievementRate}%
                                                </div>
                                            </div>
                                            <small class="text-muted">${week.saved.toFixed(1)}/${week.target.toFixed(1)}kWh</small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="themed-border p-3 mb-3">
                            <small>
                                <strong>ğŸ’° ì ˆì•½ ì˜ˆìƒ ê¸ˆì•¡</strong><br>
                                í˜„ì¬ ${tier}êµ¬ê°„ ê¸°ì¤€: ${targetKwh}kWh ì ˆì•½ ì‹œ <strong>ì›” ${formatMoney(targetMoney)}</strong> ì ˆì•½ ì˜ˆìƒ
                                ${prediction ? `<br>ğŸ“Š ì˜ˆìƒ ì‚¬ìš©ëŸ‰: ${prediction.predictedUsage}kWh/ì›” (ì‹ ë¢°ë„: ${prediction.confidence})` : ''}
                            </small>
                        </div>

                        <div class="text-muted small mb-3">
                            <div>ê¸°ê°„: ${challenge.startDate} ~ ${challenge.endDate}</div>
                            <div>ëª©í‘œ: ${targetKwh} kWh (ì›” ${formatMoney(targetMoney)} ì ˆì•½)</div>
                            ${prediction ? `<div style="color: var(--theme-strong);">ğŸ’¡ í•œì „ í†µê³„ ê¸°ë°˜ ì˜ˆì¸¡ ë°ì´í„° ì‚¬ìš©</div>` : ''}
                        </div>

                        <div class="d-flex gap-2">
                            <a href="challenge-detail.html" class="btn btn-theme-primary flex-fill">
                                ìƒì„¸ ë³´ê¸° â†’
                            </a>
                            <a href="survey.html" class="btn btn-theme-secondary">
                                ë§ì¶¤í˜• ì ˆì•½íŒ ë°›ê¸°
                            </a>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('userPoints').textContent = (points || 0).toLocaleString();
            document.getElementById('totalSaved').textContent = formatKwhWithMoney(totalSaved || 0, tier);
            renderActiveChallengeCard(challenge, tier);

            // ë­í‚¹ ì¡°íšŒ
            loadMyRank();

            // ë°°ì§€ í‘œì‹œ
            displayBadges(badges || []);

            // ì±Œë¦°ì§€ê°€ ìˆìœ¼ë©´ ìƒˆ ì±Œë¦°ì§€ ì¹´ë“œ ìˆ¨ê¸°ê¸°
            document.getElementById('newChallengeCard').style.display = 'none';
        }

        function showNoChallengeState() {
            document.getElementById('challengeStatus').innerHTML = `
                <div class="col-12">
                    <div class="themed-card text-center">
                        <h5 class="fw-bold mb-2">ì•„ì§ ì°¸ì—¬ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ì–´ìš”</h5>
                        <p class="text-muted mb-3">ìš°ë¦¬ ë™ë„¤ì—ì„œ ì§„í–‰ ì¤‘ì¸ í™˜ê²½ë³´í˜¸ í™œë™ì„ ì°¾ì•„ ì°¸ì—¬í•˜ê³  í¬ì¸íŠ¸ë„ ë°›ì•„ë³´ì„¸ìš”.</p>
                        <button type="button" class="btn btn-theme-primary px-4" onclick="document.getElementById('newChallengeCard').scrollIntoView({ behavior: 'smooth' });">
                            ì§ì ‘ ëª©í‘œ ì„¤ì •í•˜ê¸°
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('newChallengeCard').style.display = '';
            
            const emptyMessage = document.getElementById('activeChallengesEmpty');
            const activeList = document.getElementById('activeChallengesList');
            if (emptyMessage) {
                emptyMessage.classList.remove('d-none');
            }
            if (activeList) {
                activeList.classList.add('d-none');
                activeList.innerHTML = '';
            }

            const heroMessage = document.getElementById('heroRankMessage');
            if (heroMessage) {
                heroMessage.textContent = 'ìƒˆ ì±Œë¦°ì§€ë¥¼ ì‹œì‘í•˜ë©´ Flamyê°€ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤„ê²Œìš”!';
            }
        }

        // ë­í‚¹ ì¡°íšŒ
        async function loadMyRank() {
            try {
                const response = await fetch(getApiUrl('/api/ranking'));
                const data = await response.json();

                if (data.success) {
                    const myRanking = data.rankings.findIndex(r => r.id === user.id);
                    if (myRanking !== -1) {
                        const rankValue = data.rankings[myRanking].rank;
                        const messageTarget = document.getElementById('heroRankMessage');
                        if (messageTarget) {
                            messageTarget.innerHTML = `<strong>${rankValue}ìœ„</strong>ì—ì„œ ì—´ì‹¬íˆ ë‹¬ë¦¬ëŠ” ì¤‘!`;
                        }
                    } else {
                        const messageTarget = document.getElementById('heroRankMessage');
                        if (messageTarget) {
                            messageTarget.textContent = 'ì•„ì§ ìˆœìœ„ì— ì§„ì…í•˜ì§€ ì•Šì•˜ì–´ìš”. ì´ë²ˆ ì£¼ë„ ë„ì „í•´ë³¼ê¹Œìš”?';
                        }
                    }
                } else {
                    const messageTarget = document.getElementById('heroRankMessage');
                    if (messageTarget) {
                        messageTarget.textContent = 'ë­í‚¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
                    }
                }
            } catch (error) {
                console.error('ë­í‚¹ ì¡°íšŒ ì‹¤íŒ¨:', error);
                const messageTarget = document.getElementById('heroRankMessage');
                if (messageTarget) {
                    messageTarget.textContent = 'Flamyê°€ ë­í‚¹ ì„œë²„ì™€ ì—°ê²° ì¤‘ì´ì—ìš”...';
                }
            }
        }

        // ë°°ì§€ ëª©ë¡ ë¡œë“œ
        async function loadBadges() {
            try {
                const response = await fetch(getApiUrl('/api/challenge/badges'));
                const data = await response.json();

                if (data.success) {
                    allBadges = data.badges;
                }
            } catch (error) {
                console.error('ë°°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ë°°ì§€ í‘œì‹œ
        async function displayBadges(userBadgeIds) {
            // allBadgesê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë‹¤ì‹œ ì‹œë„
            if (!allBadges || allBadges.length === 0) {
                await loadBadges();
            }
            
            if (!allBadges || allBadges.length === 0) {
                document.getElementById('myBadges').innerHTML = '<p class="text-muted">ë±ƒì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
                return;
            }

            // íšë“í•œ ë±ƒì§€ë§Œ í‘œì‹œ
            const earnedBadges = allBadges.filter(badge => userBadgeIds && userBadgeIds.includes(badge.id));
            
            if (earnedBadges.length === 0) {
                document.getElementById('myBadges').innerHTML = `
                    <div class="col-12 text-center py-3">
                        <p class="text-muted mb-3">ì•„ì§ íšë“í•œ ë°°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <a href="badges.html" class="btn btn-theme-secondary">ë±ƒì§€ êµ¬ê²½í•˜ê¸° âœ¨</a>
                    </div>
                `;
                return;
            }

            const badgesHtml = earnedBadges.map(badge => {
                return `
                    <div class="col-md-3 col-6">
                        <div class="themed-border text-center" style="min-height: 120px;">
                            <div class="card-body p-3">
                                <div style="font-size: 3rem;">${badge.icon}</div>
                                <h6 class="fw-bold mt-2">${badge.name}</h6>
                                <span class="tag-pill">íšë“</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('myBadges').innerHTML = badgesHtml;
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            try {
                const response = await fetch(getApiUrl('/api/challenge/stats'));
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalParticipants').textContent = data.stats.totalParticipants || 0;
                }
            } catch (error) {
                console.error('í†µê³„ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ëª©í‘œ ê¸ˆì•¡ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateTargetMoney() {
            const targetKwh = parseFloat(document.getElementById('targetKwh').value) || 0;
            if (targetKwh > 0) {
                const money = convertKwhToMoney(targetKwh, userEnergyTier);
                document.getElementById('targetMoneyAmount').textContent = formatMoney(money);
                document.getElementById('targetMoneyPreview').style.display = 'block';
            } else {
                document.getElementById('targetMoneyPreview').style.display = 'none';
            }
        }

        // ì±Œë¦°ì§€ ìƒì„± í¼ ì œì¶œ
        document.getElementById('challengeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const type = document.querySelector('input[name="type"]:checked').value;
            const targetKwh = parseFloat(document.getElementById('targetKwh').value);

            if (!targetKwh || targetKwh <= 0) {
                alert('ì ˆì•½ ëª©í‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const targetMoney = convertKwhToMoney(targetKwh, userEnergyTier);
            if (!confirm(`${targetKwh}kWh ì ˆì•½ ëª©í‘œë¥¼ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì˜ˆìƒ ì ˆì•½ ê¸ˆì•¡: ì›” ${formatMoney(targetMoney)}`)) {
                return;
            }

            try {
                const response = await fetch(getApiUrl('/api/challenge/create'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        type,
                        targetKwh,
                        startDate: new Date().toISOString().split('T')[0]
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('ì±Œë¦°ì§€ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    location.reload();
                } else {
                    alert(data.message || 'ì±Œë¦°ì§€ ìƒì„± ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ì´ˆê¸°í™”
        init();
    </script>
</body>
</html>

