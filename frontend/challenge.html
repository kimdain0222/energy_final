<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë„ˆì§€ ì ˆì•½ ì±Œë¦°ì§€ - ì—ë„ˆì§€ ì ˆì•½ í”Œë«í¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .badge-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        .progress-ring {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }
        .challenge-card {
            transition: transform 0.2s;
        }
        .challenge-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="index.html">âš¡ ì—ë„ˆì§€ì ˆì•½</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">ëŒ€ì‹œë³´ë“œ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="challenge.html">ì±Œë¦°ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ranking.html">ë­í‚¹</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="programs.html">ì§€ì›ì‚¬ì—…</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <!-- ë‚´ ì±Œë¦°ì§€ í˜„í™© -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="fw-bold mb-4">ğŸ† ì—ë„ˆì§€ ì ˆì•½ ì±Œë¦°ì§€</h2>
            </div>
        </div>

        <div id="challengeStatus" class="row g-4 mb-5">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
        </div>

        <!-- ìƒˆ ì±Œë¦°ì§€ ì‹œì‘ -->
        <div class="card border-0 shadow-sm mb-5" id="newChallengeCard">
            <div class="card-body p-5">
                <h4 class="fw-bold mb-4">ìƒˆ ì±Œë¦°ì§€ ì‹œì‘í•˜ê¸°</h4>
                <form id="challengeForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">ëª©í‘œ ìœ í˜•</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="type" id="weekly" value="weekly" checked>
                                <label class="btn btn-outline-primary" for="weekly">ì£¼ê°„ ëª©í‘œ (7ì¼)</label>
                                
                                <input type="radio" class="btn-check" name="type" id="monthly" value="monthly">
                                <label class="btn btn-outline-primary" for="monthly">ì›”ê°„ ëª©í‘œ (30ì¼)</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ì ˆì•½ ëª©í‘œ</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="targetKwh" placeholder="ì˜ˆ: 50" required oninput="updateTargetMoney()">
                                <span class="input-group-text">kWh</span>
                            </div>
                            <small class="text-muted mt-2 d-block" id="targetMoneyPreview">
                                ëª©í‘œ ê¸ˆì•¡: <span id="targetMoneyAmount">-</span>
                            </small>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5">ì±Œë¦°ì§€ ì‹œì‘í•˜ê¸° ğŸš€</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ë‚´ ë°°ì§€ -->
        <div class="card border-0 shadow-sm mb-5">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-4">ğŸ… íšë“í•œ ë°°ì§€</h5>
                <div id="myBadges" class="row g-3">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                </div>
            </div>
        </div>

        <!-- í¬ì¸íŠ¸ & í†µê³„ -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm text-center">
                    <div class="card-body p-4">
                        <h3 class="text-primary mb-2">ğŸ’ í¬ì¸íŠ¸</h3>
                        <h2 class="fw-bold" id="userPoints">0</h2>
                        <small class="text-muted">1kWhë‹¹ 10í¬ì¸íŠ¸</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm text-center">
                    <div class="card-body p-4">
                        <h3 class="text-success mb-2">âš¡ ì´ ì ˆì•½ëŸ‰</h3>
                        <h2 class="fw-bold" id="totalSaved">0</h2>
                        <small class="text-muted">kWh</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm text-center">
                    <div class="card-body p-4">
                        <h3 class="text-info mb-2">ğŸ¯ ì°¸ì—¬ì ìˆ˜</h3>
                        <h2 class="fw-bold" id="totalParticipants">-</h2>
                        <small class="text-muted">ëª…</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì§„í–‰ì¤‘ì¸ ì±Œë¦°ì§€ ëª©ë¡ -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-4">ğŸ”¥ ì§„í–‰ì¤‘ì¸ ì±Œë¦°ì§€</h5>
                <div id="activeChallenges">
                    <p class="text-muted text-center py-4">ì§„í–‰ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì±Œë¦°ì§€ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!user.id) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        let userChallenge = null;
        let allBadges = [];
        let userEnergyTier = 2; // ê¸°ë³¸ê°’ 2êµ¬ê°„

        // kWh â†’ ê¸ˆì•¡ í™˜ì‚° í•¨ìˆ˜
        function convertKwhToMoney(kwh, tier = null) {
            const rates = {
                1: 93.3,    // 1êµ¬ê°„ (200kWh ì´í•˜)
                2: 187.9,   // 2êµ¬ê°„ (201-400kWh)
                3: 280.6,   // 3êµ¬ê°„ (401kWh ì´ìƒ)
                4: 416.1    // 4êµ¬ê°„ (íŠ¹ê³ ì••)
            };
            
            const rate = tier ? rates[tier] || 187.9 : 187.9; // tierê°€ ì—†ìœ¼ë©´ í‰ê·  ë‹¨ê°€ ì‚¬ìš©
            return Math.round(kwh * rate);
        }

        // ê¸ˆì•¡ í¬ë§·íŒ…
        function formatMoney(amount) {
            return amount.toLocaleString() + 'ì›';
        }

        // kWhì™€ ê¸ˆì•¡ì„ í•¨ê»˜ í‘œì‹œí•˜ëŠ” í…ìŠ¤íŠ¸ ìƒì„±
        function formatKwhWithMoney(kwh, tier = null) {
            const money = convertKwhToMoney(kwh, tier);
            return `${kwh}kWh (ì›” ${formatMoney(money)})`;
        }

        // í˜ì´ì§€ ë¡œë“œ
        async function init() {
            await loadChallenge();
            await loadBadges();
            await loadStats();
        }

        // ì±Œë¦°ì§€ ì¡°íšŒ
        async function loadChallenge() {
            try {
                const response = await fetch(`/api/challenge/user/${user.id}`);
                const data = await response.json();

                if (data.success) {
                    userChallenge = data.challenge;
                    userEnergyTier = data.energyTier || 2;
                    displayChallengeStatus(data.challenge, data.totalSaved, data.points, data.badges, data.energyTier);
                } else {
                    document.getElementById('challengeStatus').innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                <p class="mb-0">ì§„í–‰ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ì±Œë¦°ì§€ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ì±Œë¦°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ì±Œë¦°ì§€ ìƒíƒœ í‘œì‹œ
        function displayChallengeStatus(challenge, totalSaved, points, badges, tier = 2) {
            if (!challenge) {
                return;
            }

            const achievementRate = challenge.achievementRate || 0;
            const remaining = Math.max(0, (challenge.targetKwh || 0) - (challenge.savedKwh || 0));
            const savedKwh = challenge.savedKwh || 0;
            const targetKwh = challenge.targetKwh || 0;
            
            // ê¸ˆì•¡ í™˜ì‚°
            const savedMoney = convertKwhToMoney(savedKwh, tier);
            const targetMoney = convertKwhToMoney(targetKwh, tier);
            const remainingMoney = convertKwhToMoney(remaining, tier);

            document.getElementById('challengeStatus').innerHTML = `
                <div class="col-md-8">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-4">ë‚´ ì±Œë¦°ì§€ í˜„í™©</h5>
                            
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>ëª©í‘œ ë‹¬ì„±ë¥ </span>
                                    <span class="fw-bold">${achievementRate}%</span>
                                </div>
                                <div class="progress" style="height: 30px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: ${Math.min(achievementRate, 100)}%" 
                                         aria-valuenow="${achievementRate}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        ${achievementRate}%
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted mb-1">ì ˆì•½ëŸ‰</h6>
                                            <h4 class="fw-bold text-success">${savedKwh}</h4>
                                            <small class="text-muted d-block">kWh</small>
                                            <small class="text-success fw-bold">ì›” ${formatMoney(savedMoney)}</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted mb-1">ëª©í‘œê¹Œì§€</h6>
                                            <h4 class="fw-bold text-primary">${remaining}</h4>
                                            <small class="text-muted d-block">kWh ë‚¨ìŒ</small>
                                            <small class="text-primary fw-bold">ì•½ ${formatMoney(remainingMoney)}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info mb-3">
                                <small>
                                    <strong>ğŸ’° ì ˆì•½ ì˜ˆìƒ ê¸ˆì•¡</strong><br>
                                    í˜„ì¬ ${tier}êµ¬ê°„ ê¸°ì¤€: ${targetKwh}kWh ì ˆì•½ ì‹œ <strong>ì›” ${formatMoney(targetMoney)}</strong> ì ˆì•½ ì˜ˆìƒ
                                </small>
                            </div>

                            <div class="text-muted small mb-3">
                                <div>ê¸°ê°„: ${challenge.startDate} ~ ${challenge.endDate}</div>
                                <div>ëª©í‘œ: ${targetKwh} kWh (ì›” ${formatMoney(targetMoney)} ì ˆì•½)</div>
                            </div>

                            <a href="challenge-detail.html" class="btn btn-primary w-100">
                                ìƒì„¸ ë³´ê¸° â†’
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body p-4 text-center">
                            <h5 class="fw-bold mb-3">ë‚´ ìˆœìœ„</h5>
                            <h2 class="display-4 fw-bold text-primary mb-2" id="myRank">-</h2>
                            <p class="text-muted mb-4">ìœ„</p>
                            <a href="ranking.html" class="btn btn-outline-primary">ì „ì²´ ë­í‚¹ ë³´ê¸°</a>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('userPoints').textContent = (points || 0).toLocaleString();
            document.getElementById('totalSaved').textContent = formatKwhWithMoney(totalSaved || 0, tier);

            // ë­í‚¹ ì¡°íšŒ
            loadMyRank();

            // ë°°ì§€ í‘œì‹œ
            displayBadges(badges || []);

            // ì±Œë¦°ì§€ê°€ ìˆìœ¼ë©´ ìƒˆ ì±Œë¦°ì§€ ì¹´ë“œ ìˆ¨ê¸°ê¸°
            document.getElementById('newChallengeCard').style.display = 'none';
        }

        // ë­í‚¹ ì¡°íšŒ
        async function loadMyRank() {
            try {
                const response = await fetch('/api/ranking');
                const data = await response.json();

                if (data.success) {
                    const myRanking = data.rankings.findIndex(r => r.id === user.id);
                    if (myRanking !== -1) {
                        document.getElementById('myRank').textContent = data.rankings[myRanking].rank || '-';
                    }
                }
            } catch (error) {
                console.error('ë­í‚¹ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ë°°ì§€ ëª©ë¡ ë¡œë“œ
        async function loadBadges() {
            try {
                const response = await fetch('/api/badges');
                const data = await response.json();

                if (data.success) {
                    allBadges = data.badges;
                }
            } catch (error) {
                console.error('ë°°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ë°°ì§€ í‘œì‹œ
        async function displayBadges(userBadgeIds) {
            const badgesHtml = allBadges.map(badge => {
                const hasBadge = userBadgeIds && userBadgeIds.includes(badge.id);
                return `
                    <div class="col-md-3 col-6">
                        <div class="card border-0 shadow-sm text-center ${hasBadge ? '' : 'opacity-50'}" style="min-height: 120px;">
                            <div class="card-body p-3">
                                <div style="font-size: 3rem;">${badge.icon}</div>
                                <h6 class="fw-bold mt-2">${badge.name}</h6>
                                ${hasBadge ? '<span class="badge bg-success">íšë“</span>' : '<span class="badge bg-secondary">ë¯¸íšë“</span>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('myBadges').innerHTML = badgesHtml || '<p class="text-muted">ë°°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            try {
                const response = await fetch('/api/challenge/stats');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalParticipants').textContent = data.stats.totalParticipants || 0;
                }
            } catch (error) {
                console.error('í†µê³„ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ëª©í‘œ ê¸ˆì•¡ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateTargetMoney() {
            const targetKwh = parseFloat(document.getElementById('targetKwh').value) || 0;
            if (targetKwh > 0) {
                const money = convertKwhToMoney(targetKwh, userEnergyTier);
                document.getElementById('targetMoneyAmount').textContent = formatMoney(money);
                document.getElementById('targetMoneyPreview').style.display = 'block';
            } else {
                document.getElementById('targetMoneyPreview').style.display = 'none';
            }
        }

        // ì±Œë¦°ì§€ ìƒì„± í¼ ì œì¶œ
        document.getElementById('challengeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const type = document.querySelector('input[name="type"]:checked').value;
            const targetKwh = parseFloat(document.getElementById('targetKwh').value);

            if (!targetKwh || targetKwh <= 0) {
                alert('ì ˆì•½ ëª©í‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const targetMoney = convertKwhToMoney(targetKwh, userEnergyTier);
            if (!confirm(`${targetKwh}kWh ì ˆì•½ ëª©í‘œë¥¼ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì˜ˆìƒ ì ˆì•½ ê¸ˆì•¡: ì›” ${formatMoney(targetMoney)}`)) {
                return;
            }

            try {
                const response = await fetch('/api/challenge/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        type,
                        targetKwh,
                        startDate: new Date().toISOString().split('T')[0]
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('ì±Œë¦°ì§€ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    location.reload();
                } else {
                    alert(data.message || 'ì±Œë¦°ì§€ ìƒì„± ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ì´ˆê¸°í™”
        init();
    </script>
</body>
</html>

